<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Debug V58 - Extrator de Texto Puro</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-10 font-mono">

    <div class="max-w-2xl mx-auto">
        <h1 class="text-xl font-bold mb-4 text-green-400">DEBUGGER V58</h1>
        
        <input type="password" id="apiKey" class="w-full bg-gray-800 border border-gray-700 p-2 mb-4 rounded" placeholder="Cole sua API Key aqui...">
        
        <div id="dropZone" class="border-2 border-dashed border-gray-600 p-10 text-center cursor-pointer hover:bg-gray-800 transition rounded-lg">
            <p class="text-gray-400">Arraste a imagem problem√°tica aqui</p>
            <input type="file" id="fileInput" class="hidden">
        </div>

        <div id="output" class="mt-6 p-4 bg-black border border-green-900 text-green-500 text-xs overflow-auto h-96 hidden whitespace-pre-wrap"></div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const output = document.getElementById('output');
        const apiKeyInput = document.getElementById('apiKey');

        // Carrega chave salva
        if(localStorage.getItem('vision_key')) apiKeyInput.value = localStorage.getItem('vision_key');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => process(e.target.files[0]);
        dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('bg-gray-800'); };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('bg-gray-800'); process(e.dataTransfer.files[0]); };

        function toBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
            });
        }

        async function process(file) {
            const key = apiKeyInput.value.trim();
            if(!key) return alert("Falta API Key");
            localStorage.setItem('vision_key', key);

            output.classList.remove('hidden');
            output.innerText = "Lendo imagem...";

            try {
                const base64 = await toBase64(file);
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] })
                });
                
                const json = await res.json();
                const fullText = json.responses[0]?.fullTextAnnotation?.text || "SEM TEXTO";
                
                // Formata o texto com separadores visuais para eu entender a quebra de linha
                const debugText = fullText.replace(/\n/g, ' [QUEBRA] \n');
                
                output.innerText = debugText;
                
            } catch (e) {
                output.innerText = "ERRO: " + e.message;
            }
        }
    </script>
</body>
</html>
