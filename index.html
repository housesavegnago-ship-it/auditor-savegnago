<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor V52 - Raio-X (Extrator Puro)</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Consolas', 'Courier New', monospace; background-color: #1e1e1e; color: #d4d4d4; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: #333; height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #444; }
        
        .drop-zone { border: 2px dashed #555; border-radius: 8px; background: #252526; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; margin-bottom: 20px; }
        .drop-zone:hover { border-color: #007acc; background: #2d2d30; }

        .result-card { background: #252526; border: 1px solid #333; margin-bottom: 20px; padding: 15px; border-radius: 4px; }
        
        .raw-text-box { 
            background: #1e1e1e; border: 1px solid #444; color: #ce9178; 
            padding: 10px; font-size: 11px; white-space: pre-wrap; 
            max-height: 200px; overflow-y: auto; margin-top: 5px;
        }

        .price-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .price-tag { background: #0e639c; color: white; padding: 2px 6px; font-size: 12px; border-radius: 3px; }
        
        .img-preview { max-width: 100px; max-height: 100px; border: 1px solid #555; margin-right: 15px; }
    </style>
</head>
<body>

    <header class="header">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-microscope text-yellow-500"></i>
            <h1 class="font-bold text-sm">V52 - Raio-X de Dados</h1>
        </div>
        <div class="flex gap-2">
            <input type="password" id="apiKey" class="bg-black border border-gray-600 text-white text-xs p-1 rounded w-40" placeholder="API Key Vision...">
            <button onclick="saveKey()" class="bg-blue-700 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded">SALVAR</button>
        </div>
    </header>

    <div class="flex flex-1 p-5 gap-5 overflow-hidden">
        <div class="w-1/3 flex flex-col">
            <div id="dropZone" class="drop-zone">
                <i class="fa-solid fa-upload text-2xl text-gray-500 mb-2"></i>
                <div class="text-xs text-gray-400">ARRASTE AS IMAGENS AQUI</div>
                <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
            </div>
            
            <div class="text-xs text-gray-500 mb-2">LOG DE PROCESSO:</div>
            <div id="consoleLog" class="flex-1 bg-black border border-gray-700 p-2 text-xs text-green-500 overflow-y-auto font-mono">
                > Aguardando imagens...
            </div>
        </div>

        <div class="w-2/3 flex flex-col overflow-y-auto" id="resultsArea">
            <div class="text-center mt-20 text-gray-600 italic">
                Os dados extraídos aparecerão aqui.
            </div>
        </div>
    </div>

    <script>
        function log(msg) {
            const d = document.getElementById('consoleLog');
            d.innerHTML += `<div>> ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        const apiKeyInput = document.getElementById('apiKey');
        if(localStorage.getItem('vision_key')) apiKeyInput.value = localStorage.getItem('vision_key');
        
        function saveKey() {
            localStorage.setItem('vision_key', apiKeyInput.value.trim());
            alert("Chave salva!");
        }

        let files = [];
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFiles(Array.from(e.target.files));
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#007acc'; };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#555'; handleFiles(Array.from(e.dataTransfer.files)); };

        function handleFiles(newFiles) {
            const key = apiKeyInput.value.trim();
            if(!key) return alert("Falta a API Key!");
            
            document.getElementById('resultsArea').innerHTML = '';
            
            newFiles.forEach(file => {
                log(`Processando ${file.name}...`);
                analyze(file, key);
            });
        }

        async function toBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
            });
        }

        async function analyze(file, key) {
            try {
                const base64 = await toBase64(file);
                
                // Chamada Simples e Direta
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] })
                });

                if(!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                const fullText = data.responses[0]?.fullTextAnnotation?.text || "[SEM TEXTO DETECTADO]";
                
                // REGEX DE TESTE (Preços)
                // Procura: digitos, ponto ou virgula, 2 digitos
                const prices = [];
                const regex = /(\d{1,3}(?:\.\d{3})*)[,.](\d{2})/g;
                let match;
                while ((match = regex.exec(fullText)) !== null) {
                    // Filtra anos (2025, 2026) se nao tiver cifrão
                    const val = parseFloat(match[0].replace('.','').replace(',','.'));
                    if(val >= 2020 && val <= 2030 && !fullText.includes('$' + match[0])) continue;
                    
                    prices.push(match[0]); // Mantém o formato original (string) para ver como leu
                }

                renderResult(file, fullText, prices);
                log(`${file.name}: Sucesso. ${fullText.length} caracteres.`);

            } catch (e) {
                log(`ERRO ${file.name}: ${e.message}`);
                document.getElementById('resultsArea').innerHTML += `<div class="result-card border-red-500 text-red-400">Erro: ${e.message}</div>`;
            }
        }

        function renderResult(file, text, prices) {
            const container = document.getElementById('resultsArea');
            
            const priceTags = prices.length > 0 
                ? prices.map(p => `<span class="price-tag">${p}</span>`).join(' ')
                : `<span class="text-gray-500 text-xs">Nenhum padrão de preço (XX,XX) identificado.</span>`;

            const html = `
                <div class="result-card">
                    <div class="flex items-start">
                        <div class="flex-1">
                            <div class="font-bold text-white mb-2 text-sm border-b border-gray-700 pb-2">
                                ARQUIVO: ${file.name}
                            </div>
                            
                            <div class="mb-3">
                                <div class="text-xs text-gray-400 font-bold mb-1">1. PREÇOS IDENTIFICADOS (Filtro):</div>
                                <div class="price-list">${priceTags}</div>
                            </div>

                            <div>
                                <div class="text-xs text-gray-400 font-bold mb-1">2. LEITURA BRUTA (Tudo que o robô viu):</div>
                                <div class="raw-text-box">${text}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', html);
        }
    </script>
</body>
</html>
