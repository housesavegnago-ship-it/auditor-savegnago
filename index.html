<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator V54 - Organizador Savegnago</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: #0f172a; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; }
        
        .drop-zone { border: 2px dashed #94a3b8; border-radius: 8px; background: #f1f5f9; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .drop-zone:hover { border-color: #3b82f6; background: #eff6ff; }

        .result-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        
        /* Tipografia de Dados */
        .data-label { font-size: 10px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        
        .title-box { font-size: 14px; color: #1e293b; font-weight: 600; line-height: 1.4; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 8px; }
        
        .base-price-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 8px; border-radius: 6px; display: inline-block; min-width: 120px; text-align: center; }
        .base-val { font-size: 18px; font-weight: 800; color: #166534; font-family: monospace; }
        
        .offer-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
        .offer-type { font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .offer-val { font-size: 14px; font-weight: 700; color: #334155; font-family: monospace; }

        /* Cores de Ofertas */
        .type-save { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .type-card { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .type-client { background: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
        .type-pack { background: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }
        .type-other { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

        .raw-text { font-family: monospace; font-size: 10px; color: #94a3b8; margin-top: 10px; background: #f8fafc; padding: 8px; border-radius: 4px; white-space: pre-wrap; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body class="text-slate-800">

    <header class="header">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded text-white"><i class="fa-solid fa-database"></i></div>
            <div>
                <h1 class="font-bold text-lg leading-none">Extrator V54</h1>
                <p class="text-[10px] text-slate-400">Organizador Inteligente (Sem Lista)</p>
            </div>
        </div>
        <div class="flex gap-2">
            <input type="password" id="apiKey" class="bg-slate-800 border border-slate-700 text-white text-xs p-1.5 rounded w-32" placeholder="API Key Vision...">
            <button onclick="saveKey()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded">SALVAR</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[30%] bg-white border-r border-slate-200 flex flex-col p-4 shadow-xl z-10">
            <div class="h-full">
                <div id="dropZone" class="drop-zone">
                    <i class="fa-solid fa-file-import text-4xl text-slate-300 mb-3"></i>
                    <div class="text-sm font-bold text-slate-600">ARRASTE AS IMAGENS</div>
                    <div class="text-xs text-slate-400 mt-1">Extração automática de dados</div>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                </div>
            </div>
        </div>

        <div class="w-[70%] bg-slate-50 relative flex flex-col">
            <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div>
                <div class="text-sm font-bold text-blue-900 animate-pulse">Lendo estrutura do encarte...</div>
            </div>

            <div class="p-4 border-b border-slate-200 bg-white shadow-sm flex justify-between items-center">
                <span class="font-bold text-xs text-slate-600">DADOS EXTRAÍDOS</span>
                <button onclick="document.getElementById('resultsArea').innerHTML=''" class="text-[10px] text-red-500 hover:underline">LIMPAR TELA</button>
            </div>

            <div id="resultsArea" class="flex-1 overflow-y-auto p-6">
                <div class="text-center mt-20 text-slate-400 text-sm italic">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Arraste as imagens para começar.
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKey');
        if(localStorage.getItem('vision_key')) apiKeyInput.value = localStorage.getItem('vision_key');
        
        function saveKey() {
            localStorage.setItem('vision_key', apiKeyInput.value.trim());
            alert("Chave salva!");
        }

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => processFiles(Array.from(e.target.files));
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#3b82f6'; };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#94a3b8'; processFiles(Array.from(e.dataTransfer.files)); };

        async function processFiles(files) {
            const key = apiKeyInput.value.trim();
            if(!key) return alert("Falta API Key!");
            
            document.getElementById('loading').classList.remove('hidden');
            const container = document.getElementById('resultsArea');
            if(container.innerText.includes('Arraste')) container.innerHTML = '';

            for (const file of files) {
                try {
                    await extractData(file, key, container);
                } catch (err) {
                    container.innerHTML = `<div class="p-3 bg-red-100 text-red-800 text-xs mb-4 rounded">Erro ${file.name}: ${err.message}</div>` + container.innerHTML;
                }
            }
            document.getElementById('loading').classList.add('hidden');
        }

        async function extractData(file, key, container) {
            // 1. OCR
            const base64 = await toBase64(file);
            const apiRes = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                method: 'POST',
                body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] })
            });
            const data = await apiRes.json();
            const fullText = data.responses[0]?.fullTextAnnotation?.text || "";

            // 2. LÓGICA DE ORGANIZAÇÃO (O "EXTRATOR")
            const info = parseSavegnagoLayout(fullText);

            // 3. RENDERIZAÇÃO
            renderCard(container, file.name, info, fullText);
        }

        function parseSavegnagoLayout(text) {
            const result = {
                title: "Não identificado",
                basePrice: null,
                offers: []
            };

            // A. Extração do Título
            // Regra: Do início até achar unidade (kg, g, ml) ou o primeiro R$
            const cleanText = text.replace(/\r/g, '');
            const titleMatch = cleanText.match(/^(.*?)(?=\d+\s*(?:kg|g|ml|l|un)|R\$|\d+[.,]\d{2})/is);
            if (titleMatch) result.title = titleMatch[1].replace(/\n/g, ' ').trim();

            // B. Encontrar todos os preços e suas posições
            const prices = [];
            const priceRegex = /(\d{1,3}(?:\.\d{3})*)[,.](\d{2})/g;
            let match;
            while ((match = priceRegex.exec(cleanText)) !== null) {
                const val = parseFloat(match[0].replace('.','').replace(',','.'));
                // Filtra anos
                if(val >= 2020 && val <= 2030 && !cleanText.includes('$' + match[0])) continue;
                
                prices.push({
                    val: val,
                    index: match.index,
                    str: match[0]
                });
            }

            // C. Identificar Preço Base (Gatilho: "COMPRAR")
            // Procura "COMPRAR". O preço IMEDIATAMENTE ANTES é a base.
            const buyIndex = cleanText.toUpperCase().indexOf("COMPRAR");
            
            if (buyIndex !== -1) {
                // Filtra preços que aparecem antes da palavra COMPRAR
                const candidates = prices.filter(p => p.index < buyIndex);
                if (candidates.length > 0) {
                    // O último dessa lista é o mais próximo do botão
                    const baseP = candidates[candidates.length - 1];
                    result.basePrice = baseP.val;
                    // Remove esse preço da lista geral para não duplicar como oferta
                    const idxToRemove = prices.indexOf(baseP);
                    if (idxToRemove > -1) prices.splice(idxToRemove, 1);
                }
            } else {
                // Se não tem botão comprar, assume que o maior preço ou o último sem oferta é a base?
                // Por segurança, se não tem "Comprar", deixamos Base como null ou pegamos o último preço solto.
                // Vamos deixar null para ser fiel à regra "Acima do botão comprar".
            }

            // D. Identificar Ofertas (Gatilhos de Texto)
            // Regra: Se o texto antes do preço contém a palavra chave
            const offerTriggers = [
                { key: "SAVE GANHE", type: "SAVE GANHE", css: "type-save" },
                { key: "SAVEGANHE", type: "SAVE GANHE", css: "type-save" },
                { key: "NOSSO CARTÃO", type: "CARTÃO", css: "type-card" },
                { key: "CARTÃO", type: "CARTÃO", css: "type-card" },
                { key: "CLIENTE CAMPEÃO", type: "CLIENTE", css: "type-client" },
                { key: "CLIENTE", type: "CLIENTE", css: "type-client" },
                { key: "EMBALAGEM", type: "EMBALAGEM", css: "type-pack" },
                { key: "PROMOÇÃO", type: "PROMOÇÃO", css: "type-pack" },
                { key: "A PARTIR", type: "A PARTIR", css: "type-pack" }
            ];

            prices.forEach(p => {
                // Analisa os 50 caracteres antes do preço
                const context = cleanText.substring(Math.max(0, p.index - 60), p.index).toUpperCase().replace(/\n/g, ' ');
                
                let foundType = null;
                let foundCss = "type-other";

                for (const t of offerTriggers) {
                    if (context.includes(t.key)) {
                        foundType = t.type;
                        foundCss = t.css;
                        break;
                    }
                }

                if (foundType) {
                    result.offers.push({ type: foundType, val: p.val, css: foundCss });
                } else {
                    // Se sobrou preço e não temos Base ainda, pode ser que este seja a Base (caso sem botão comprar)
                    if (result.basePrice === null) {
                        result.basePrice = p.val;
                    } else {
                        // Ou é um preço solto desconhecido
                         result.offers.push({ type: "OUTRO PREÇO", val: p.val, css: "type-other" });
                    }
                }
            });

            return result;
        }

        function renderCard(container, fileName, info, raw) {
            const div = document.createElement('div');
            div.className = "result-card animate-fade-in";
            
            // HTML das ofertas
            let offersHtml = "";
            if (info.offers.length > 0) {
                info.offers.forEach(o => {
                    offersHtml += `
                        <div class="offer-row">
                            <span class="offer-type ${o.css}">${o.type}</span>
                            <span class="offer-val">R$ ${fmt(o.val)}</span>
                        </div>
                    `;
                });
            } else {
                offersHtml = `<div class="text-xs text-slate-400 italic py-2">Nenhuma oferta especial detectada.</div>`;
            }

            // HTML da Base
            let baseHtml = "";
            if (info.basePrice) {
                baseHtml = `
                    <div class="base-price-box">
                        <div class="data-label text-green-700">PREÇO BASE</div>
                        <div class="base-val">R$ ${fmt(info.basePrice)}</div>
                    </div>
                `;
            } else {
                baseHtml = `
                    <div class="base-price-box bg-slate-100 border-slate-300">
                        <div class="data-label text-slate-500">PREÇO BASE</div>
                        <div class="text-sm font-bold text-slate-400">NÃO ACHADO</div>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="card-header">
                    <span class="font-bold text-xs text-slate-500"><i class="fa-regular fa-image mr-1"></i>${fileName}</span>
                </div>
                <div class="p-4">
                    <div class="data-label">PRODUTO IDENTIFICADO</div>
                    <div class="title-box">${info.title}</div>
                    
                    <div class="flex gap-4 mb-4 items-start">
                        ${baseHtml}
                        <div class="flex-1 bg-slate-50 p-2 rounded border border-slate-100">
                            <div class="data-label mb-1">OFERTAS & CONDIÇÕES</div>
                            ${offersHtml}
                        </div>
                    </div>

                    <details>
                        <summary class="text-[10px] text-blue-500 cursor-pointer hover:underline">Ver texto bruto lido pelo robô</summary>
                        <div class="raw-text">${raw}</div>
                    </details>
                </div>
            `;
            container.prepend(div);
        }

        function toBase64(file) {
            return new Promise((r, j) => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.onerror = j;
                reader.readAsDataURL(file);
            });
        }
        const fmt = n => n.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    </script>
</body>
</html>
