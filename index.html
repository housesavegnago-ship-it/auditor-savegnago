<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor V31 - Híbrido</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .drop-zone { border: 2px dashed #94a3b8; border-radius: 12px; transition: all 0.2s; background-color: #f1f5f9; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .drop-zone:hover { border-color: #2563eb; background-color: #eff6ff; }
        .scroll-area { overflow-y: auto; height: 100%; }
        
        /* Cards de Resultado */
        .result-card { background: white; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .result-header { padding: 10px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 12px; }
        .result-body { padding: 15px; font-size: 13px; line-height: 1.6; }
        
        /* Markdown */
        .markdown-body ul { list-style-type: disc; padding-left: 20px; }
        .markdown-body strong { color: #0f766e; }

        /* Badges do Modo Offline */
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; text-transform: uppercase; }
        .badge-ok { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge-err { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .err-box { background: #fff1f2; border-left: 3px solid #e11d48; padding: 4px 8px; font-size: 11px; margin-bottom: 2px; color: #881337; }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-slate-800 text-white p-3 h-16 flex justify-between items-center shrink-0 shadow-lg z-10">
        <div class="flex items-center gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/2910/2910768.png" class="w-8 h-8 bg-white rounded p-1">
            <div>
                <h1 class="font-bold text-lg leading-none">Auditor V31</h1>
                <p class="text-xs text-gray-400">Sistema Híbrido</p>
            </div>
        </div>
        
        <div class="flex bg-slate-700 p-1 rounded-lg">
            <button id="modeAiBtn" onclick="setMode('ai')" class="px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 bg-teal-600 text-white">
                <i class="fa-solid fa-wand-magic-sparkles"></i> IA (Gemini)
            </button>
            <button id="modeLocalBtn" onclick="setMode('local')" class="px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 text-gray-300 hover:text-white">
                <i class="fa-solid fa-microchip"></i> Offline (Local)
            </button>
        </div>

        <div id="keyArea" class="flex items-center gap-2 bg-slate-900 p-1.5 rounded border border-slate-600">
            <i class="fa-solid fa-key text-yellow-500 text-xs ml-1"></i>
            <input type="password" id="apiKeyInput" class="bg-transparent border-none text-xs text-white w-20 placeholder-gray-500 focus:w-40 transition-all" placeholder="API Key...">
            <button onclick="saveKey()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded">Salvar</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[30%] bg-white border-r border-gray-200 flex flex-col z-20 shadow-xl p-4 gap-3">
            <div class="flex flex-col h-1/2">
                <label class="font-bold text-gray-700 mb-1 text-xs flex justify-between">
                    <span>1. Lista Gabarito</span>
                    <button onclick="document.getElementById('listInput').value = ''" class="text-[10px] text-red-500 hover:text-red-700 font-bold uppercase"><i class="fa-solid fa-trash-can mr-1"></i>Limpar</button>
                </label>
                <textarea id="listInput" class="flex-1 p-3 border rounded-lg bg-gray-50 text-xs font-mono resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cole a lista correta aqui..."></textarea>
            </div>

            <div class="flex flex-col h-1/2">
                <label class="font-bold text-gray-700 mb-1 text-xs">2. Imagens</label>
                <div id="dropZone" class="drop-zone h-full p-2 text-center group relative">
                    <div id="dropContent">
                        <i id="modeIcon" class="fa-solid fa-cloud-arrow-up text-3xl text-gray-300 group-hover:text-blue-500 mb-2 transition-colors"></i>
                        <p class="text-xs text-gray-500 font-medium">Clique ou Arraste</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                </div>
            </div>

            <button id="startBtn" onclick="processQueue()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md transition text-xs flex justify-center items-center gap-2">
                <i class="fa-solid fa-play"></i> Iniciar Análise
            </button>
        </div>

        <div class="w-[70%] bg-slate-50 flex flex-col relative overflow-hidden">
            <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
                <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div>
                <div id="loadingText" class="text-blue-800 font-bold text-sm animate-pulse">Processando...</div>
                <div id="offlineHint" class="hidden mt-4 text-xs text-gray-500">Se a IA falhar, mude para o modo Offline.</div>
            </div>

            <div class="p-3 bg-white border-b border-gray-200 font-bold text-gray-700 shadow-sm flex justify-between text-sm">
                <span>Relatório</span>
                <span id="modeBadge" class="bg-teal-100 text-teal-800 px-2 rounded text-[10px]">Modo IA Ativo</span>
            </div>
            
            <div class="scroll-area p-6" id="resultsArea">
                <div class="text-center text-gray-400 mt-20 text-sm italic">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Configure a lista e selecione as imagens.
                </div>
            </div>
        </div>
    </div>

    <canvas id="processCanvas" class="hidden"></canvas>

    <script>
        // --- ESTADO GLOBAL ---
        let currentMode = 'ai'; // 'ai' ou 'local'
        let fileQueue = [];
        let tesseractWorker = null;

        // --- GESTÃO DE MODO ---
        function setMode(mode) {
            currentMode = mode;
            const btnAi = document.getElementById('modeAiBtn');
            const btnLocal = document.getElementById('modeLocalBtn');
            const keyArea = document.getElementById('keyArea');
            const badge = document.getElementById('modeBadge');
            const icon = document.getElementById('modeIcon');

            if (mode === 'ai') {
                btnAi.className = "px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 bg-teal-600 text-white shadow";
                btnLocal.className = "px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 text-gray-300 hover:text-white";
                keyArea.style.display = 'flex';
                badge.innerText = "Modo IA (Gemini)";
                badge.className = "bg-teal-100 text-teal-800 px-2 rounded text-[10px]";
                icon.className = "fa-solid fa-wand-magic-sparkles text-3xl text-teal-300 group-hover:text-teal-600 mb-2 transition-colors";
            } else {
                btnLocal.className = "px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 bg-blue-600 text-white shadow";
                btnAi.className = "px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 text-gray-300 hover:text-white";
                keyArea.style.display = 'none';
                badge.innerText = "Modo Offline (Tesseract)";
                badge.className = "bg-blue-100 text-blue-800 px-2 rounded text-[10px]";
                icon.className = "fa-solid fa-microchip text-3xl text-blue-300 group-hover:text-blue-600 mb-2 transition-colors";
            }
        }

        // --- GESTÃO DE CHAVE ---
        const inputField = document.getElementById('apiKeyInput');
        window.onload = () => { 
            if(localStorage.getItem('gemini_key')) inputField.value = localStorage.getItem('gemini_key'); 
            setMode('ai'); // Começa com IA por padrão
        };
        function saveKey() { localStorage.setItem('gemini_key', inputField.value.trim()); alert("Chave salva!"); }
        function getKey() { return localStorage.getItem('gemini_key') || inputField.value.trim(); }

        // --- DRAG & DROP ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const dropContent = document.getElementById('dropContent');
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);
        dropZone.ondragover = (e) => { e.preventDefault(); };
        dropZone.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };

        function handleFiles(files) {
            fileQueue = Array.from(files);
            dropContent.innerHTML = `<div class="font-bold text-slate-600">${fileQueue.length} arquivo(s)</div>`;
        }

        // --- CONTROLADOR PRINCIPAL ---
        async function processQueue() {
            const listTxt = document.getElementById('listInput').value;
            if(!listTxt) return alert("Falta a lista gabarito!");
            if(fileQueue.length === 0) return alert("Sem imagens!");

            const overlay = document.getElementById('loadingOverlay');
            const resArea = document.getElementById('resultsArea');
            if(resArea.innerText.includes('Configure')) resArea.innerHTML = '';
            
            overlay.classList.remove('hidden');
            if(currentMode === 'ai') document.getElementById('offlineHint').classList.remove('hidden');
            else document.getElementById('offlineHint').classList.add('hidden');

            // SE MODO LOCAL, INICIA TESSERACT
            if(currentMode === 'local' && !tesseractWorker) {
                document.getElementById('loadingText').innerText = "Carregando motor Local...";
                tesseractWorker = await Tesseract.createWorker('por');
            }

            for(let i=0; i<fileQueue.length; i++) {
                const file = fileQueue[i];
                document.getElementById('loadingText').innerText = `Analisando ${i+1}/${fileQueue.length}...`;
                
                try {
                    if(currentMode === 'ai') {
                        await analyzeAI(file, listTxt, resArea);
                        await new Promise(r => setTimeout(r, 2000)); // Delay p/ Google
                    } else {
                        await analyzeLocal(file, listTxt, resArea);
                    }
                } catch (err) {
                    // SE FALHAR IA, SUGERE MUDAR
                    const errorMsg = `
                        <div class="bg-red-50 p-3 rounded border border-red-200 mb-4">
                            <div class="font-bold text-red-800 text-xs">❌ Erro em ${file.name}</div>
                            <div class="text-[10px] text-red-600 mb-2">${err.message}</div>
                            ${currentMode === 'ai' ? `<button onclick="setMode('local'); processQueue()" class="bg-blue-600 text-white px-2 py-1 rounded text-[10px]">Tentar no Modo Offline</button>` : ''}
                        </div>`;
                    resArea.innerHTML = errorMsg + resArea.innerHTML;
                }
            }
            overlay.classList.add('hidden');
            fileQueue = [];
            dropContent.innerHTML = "Concluído!";
        }

        // --- MOTOR 1: IA (GEMINI) ---
        async function analyzeAI(file, listTxt, container) {
            const key = getKey();
            if(!key) throw new Error("Chave API não configurada.");
            
            const b64 = await resizeImage(file);
            const prompt = `AUDITORIA. LISTA:\n${listTxt}\nCompare a imagem com a lista. Saída Markdown curta. Se errar, explique.`;

            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: b64 } }] }] })
            });

            if(!resp.ok) throw new Error("Erro Google: " + await resp.text());
            const json = await resp.json();
            const text = json.candidates[0].content.parts[0].text;
            
            createResultCard(file.name, marked.parse(text), container, 'Gemini');
        }

        // --- MOTOR 2: LOCAL (TESSERACT) ---
        async function analyzeLocal(file, listTxt, container) {
            const imgUrl = URL.createObjectURL(file);
            
            // 1. OCR
            const img = new Image(); img.src = imgUrl; await new Promise(r => img.onload = r);
            const cvs = document.getElementById('processCanvas');
            const ctx = cvs.getContext('2d');
            cvs.width = img.width; cvs.height = img.height;
            ctx.drawImage(img,0,0);
            
            // Filtro simples
            const d = ctx.getImageData(0,0,cvs.width,cvs.height);
            for(let i=0; i<d.data.length; i+=4) {
                const v = (d.data[i]+d.data[i+1]+d.data[i+2])/3 > 140 ? 255 : 0;
                d.data[i]=d.data[i+1]=d.data[i+2]=v;
            }
            ctx.putImageData(d,0,0);
            
            const ret = await tesseractWorker.recognize(cvs.toDataURL());
            const foundPrices = (ret.data.text.match(/\d{1,4}[.,]\d{2}\b/g) || []).map(cleanPrice);
            
            // 2. COMPARAÇÃO
            let html = `<ul class="text-xs space-y-2">`;
            const products = parseList(listTxt);
            let errors = 0;

            products.forEach(p => {
                const baseOK = foundPrices.some(v => Math.abs(v - p.base) < 0.05);
                let extraOK = true;
                if(p.extra) extraOK = foundPrices.some(v => Math.abs(v - p.extra) < 0.05);

                if(baseOK && extraOK) return; // Não mostra os certos pra não poluir, ou mostra resumo

                errors++;
                html += `<li><strong>${p.name}</strong>`;
                if(!baseOK) html += `<div class="err-box">Base: Esperado R$ ${p.base} (Não achado)</div>`;
                if(p.extra && !extraOK) html += `<div class="err-box">Extra: Esperado R$ ${p.extra} (Não achado)</div>`;
                html += `</li>`;
            });
            html += `</ul>`;
            
            if(errors === 0) html = `<div class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> Todos os preços da lista encontrados na imagem.</div>`;
            else html = `<div class="mb-2 text-red-600 font-bold">Divergências Encontradas:</div>` + html;
            
            html += `<div class="mt-2 pt-2 border-t text-[10px] text-gray-400">Leitura crua: ${foundPrices.join(', ')}</div>`;

            createResultCard(file.name, html, container, 'Modo Local');
        }

        // --- UTILS ---
        function createResultCard(title, content, container, source) {
            const div = document.createElement('div');
            div.className = 'result-card animate-fade-in';
            div.innerHTML = `
                <div class="result-header">
                    <span>${title}</span>
                    <span class="text-[10px] bg-gray-100 px-2 rounded border">${source}</span>
                </div>
                <div class="result-body markdown-body">${content}</div>
            `;
            container.prepend(div);
        }

        function resizeImage(file) {
            return new Promise(r => {
                const fr = new FileReader();
                fr.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.getElementById('processCanvas');
                        const x = c.getContext('2d');
                        let w=img.width, h=img.height, m=1024;
                        if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                        c.width=w;c.height=h;x.drawImage(img,0,0,w,h);
                        r(c.toDataURL('image/jpeg',0.8).split(',')[1]);
                    };
                    img.src = e.target.result;
                };
                fr.readAsDataURL(file);
            });
        }

        const cleanPrice = s => parseFloat(s.replace(/[^0-9,]/g,'').replace(',','.'));
        
        function parseList(txt) {
            const arr = [];
            txt.split('\n').forEach(l => {
                const m = l.match(/(.+) – R\$ ([\d,.]+)/i);
                if(m && !l.trim().startsWith('(')) arr.push({name:m[1].trim(), base:cleanPrice(m[2]), extra:null});
                else if(l.trim().startsWith('(') && arr.length) {
                    const pm = l.match(/R\$ ([\d,.]+)/);
                    if(pm) arr[arr.length-1].extra = cleanPrice(pm[1]);
                }
            });
            return arr;
        }
    </script>
</body>
</html>
