<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passo 2 - Lista V71 (Multilinha)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: #0f172a; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; }
        
        .result-card { background: white; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        
        .section-label { font-size: 10px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .title-box { font-size: 15px; color: #1e293b; font-weight: 700; padding: 10px; background: #fff; border: 2px solid #e2e8f0; margin-bottom: 12px; border-radius: 6px; }
        
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 5px; }
        .price-card { padding: 12px; border-radius: 8px; border-width: 1px; border-style: solid; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .price-val { font-size: 22px; font-weight: 800; font-family: monospace; display: block; margin-top: 2px; letter-spacing: -1px; }
        
        .style-base { background: #f0fdf4; border-color: #86efac; color: #166534; }
        .style-base .tag { background: #166534; color: white; }

        .style-card { background: #eff6ff; border-color: #60a5fa; color: #1e40af; }
        .style-card .tag { background: #1d4ed8; color: white; }

        .style-save { background: #fdf2f8; border-color: #f472b6; color: #be185d; }
        .style-save .tag { background: #db2777; color: white; }

        .style-other { background: #fff7ed; border-color: #fb923c; color: #9a3412; }
        .style-other .tag { background: #ea580c; color: white; }

        .tag { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 12px; margin-bottom: 4px; }
        .debug-text { font-size: 10px; color: #9ca3af; font-family: monospace; margin-top: 10px; border-top: 1px solid #f3f4f6; padding-top: 5px; }
    </style>
</head>
<body class="text-slate-800">

    <header class="header">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-900 p-1.5 rounded text-white"><i class="fa-solid fa-layer-group"></i></div>
            <div>
                <h1 class="font-bold text-lg leading-none">Passo 2 (V71)</h1>
                <p class="text-[10px] text-indigo-200">Parser Multilinhas</p>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[40%] bg-white border-r border-slate-200 flex flex-col p-6 shadow-xl z-10">
            <label class="text-xs font-bold text-slate-500 mb-2 flex justify-between">
                COLE A LISTA
                <span class="text-indigo-600 cursor-pointer hover:underline" onclick="document.getElementById('listInput').value = ''">Limpar</span>
            </label>
            <textarea id="listInput" class="flex-1 border-2 border-slate-200 rounded-lg p-4 text-xs font-mono bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition" placeholder="Cole sua lista aqui..."></textarea>
            
            <button onclick="analyzeList()" class="mt-4 bg-indigo-800 hover:bg-indigo-700 text-white py-4 rounded-lg font-bold shadow-lg transition text-sm flex justify-center items-center gap-2">
                <i class="fa-solid fa-magic"></i> DECODIFICAR
            </button>
        </div>

        <div class="w-[60%] bg-slate-50 relative flex flex-col">
            <div class="p-4 border-b border-slate-200 bg-white shadow-sm flex justify-between items-center">
                <span class="font-bold text-xs text-slate-600">VISUALIZAÇÃO</span>
            </div>
            <div id="resultsArea" class="flex-1 overflow-y-auto p-8">
                <div class="text-center mt-20 text-slate-400 text-sm italic">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Aguardando lista.
                </div>
            </div>
        </div>
    </div>

    <script>
        function analyzeList() {
            const txt = document.getElementById('listInput').value;
            const container = document.getElementById('resultsArea');
            container.innerHTML = '';

            if(!txt.trim()) return alert("Cole uma lista primeiro!");

            // 1. FUNDIR LINHAS (Lógica Multilinha)
            const lines = txt.split('\n');
            const items = [];
            let currentItem = null;

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                // Se a linha começa com "Numero -", é um novo item
                const idMatch = line.match(/^(\d+)\s*-\s*(.+)/);
                
                if (idMatch) {
                    if (currentItem) items.push(currentItem);
                    currentItem = {
                        id: idMatch[1],
                        fullText: line // Começa com a primeira linha
                    };
                } else {
                    // Se não começa com número, é continuação do item anterior (oferta na linha de baixo)
                    if (currentItem) {
                        currentItem.fullText += " " + line;
                    }
                }
            });
            if (currentItem) items.push(currentItem);

            if (items.length === 0) {
                container.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded">Formato inválido. Use: "1 - Produto..."</div>`;
                return;
            }

            // 2. Processar cada item fundido
            items.forEach(item => {
                const structured = parseItemV71(item.fullText);
                renderItemCard(container, item.id, structured, item.fullText);
            });
        }

        // --- CÉREBRO V71: PARSER UNIFICADO ---
        function parseItemV71(text) {
            // Limpa espaços duplos criados pela fusão
            const cleanText = text.replace(/\s+/g, ' ').trim();
            
            let title = cleanText;
            let basePrice = null;
            const offers = [];

            // A. Título (Corta no (red. ou no R$)
            const titleSplit = cleanText.match(/^(.*?)(?=\s\(red|–\s*R\$|R\$)/i);
            if (titleSplit) title = titleSplit[1].replace(/^\d+\s*-\s*/, '').trim(); // Remove "1 - " do título também

            // B. Coletar Preços
            const pricesFound = [];
            const priceRegex = /R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})/gi;
            let match;
            while ((match = priceRegex.exec(cleanText)) !== null) {
                const valStr = match[1];
                const val = parseFloat(valStr.replace('.','').replace(',','.'));
                pricesFound.push({ val: val, index: match.index, assigned: false });
            }

            // C. PRIORIDADE 1: Base VIP (Antes de "(red")
            // Regex flexível: Aceita espaços opcionais entre o valor e o (red
            const redMatch = cleanText.match(/R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})\s*\(red/i);
            if (redMatch) {
                const vipVal = parseFloat(redMatch[1].replace('.','').replace(',','.'));
                const vipPrice = pricesFound.find(p => Math.abs(p.val - vipVal) < 0.001 && !p.assigned);
                if (vipPrice) {
                    basePrice = { val: vipPrice.val };
                    vipPrice.assigned = true;
                }
            }

            // D. PRIORIDADE 2: Base VIP (Depois de Travessão) - Fallback
            if (!basePrice) {
                const dashMatch = cleanText.match(/–\s*R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})/);
                if (dashMatch) {
                    const vipVal = parseFloat(dashMatch[1].replace('.','').replace(',','.'));
                    const vipPrice = pricesFound.find(p => Math.abs(p.val - vipVal) < 0.001 && !p.assigned);
                    if (vipPrice) {
                        basePrice = { val: vipPrice.val };
                        vipPrice.assigned = true;
                    }
                }
            }

            // E. CLASSIFICAR OFERTAS (Proximidade)
            const triggers = [
                { key: "NOSSO CARTÃO", type: "NOSSO CARTÃO", css: "style-card" },
                { key: "NOSSO CARTAO", type: "NOSSO CARTÃO", css: "style-card" },
                { key: "CARTÃO", type: "NOSSO CARTÃO", css: "style-card" },
                { key: "SAVE GANHE", type: "SAVE GANHE", css: "style-save" },
                { key: "SAVEGANHE", type: "SAVE GANHE", css: "style-save" },
                { key: "NO SAVE", type: "SAVE GANHE", css: "style-save" },
                { key: "CLIENTE", type: "CLIENTE CAMPEÃO", css: "style-other" },
                { key: "EMBALAGEM", type: "EMBALAGEM", css: "style-other" },
                { key: "LEVANDO", type: "EMBALAGEM", css: "style-other" },
                { key: "SAI POR", type: "EMBALAGEM", css: "style-other" },
                { key: "A PARTIR", type: "EMBALAGEM", css: "style-other" },
                { key: "UNIDADE", type: "EMBALAGEM", css: "style-other" },
                { key: "NESTA EMBALAGEM", type: "EMBALAGEM", css: "style-other" }
            ];

            pricesFound.forEach(p => {
                if (p.assigned) return;
                const context = cleanText.substring(Math.max(0, p.index - 80), p.index).toUpperCase();
                let bestTrigger = null;
                let minDistance = 9999;

                triggers.forEach(t => {
                    const lastIdx = context.lastIndexOf(t.key);
                    if (lastIdx !== -1) {
                        const distance = context.length - (lastIdx + t.key.length);
                        if (distance < minDistance) { minDistance = distance; bestTrigger = t; }
                    }
                });

                if (bestTrigger && minDistance < 60) {
                    offers.push({ type: bestTrigger.type, val: p.val, css: bestTrigger.css });
                    p.assigned = true;
                }
            });

            // F. SOBRA = BASE (Se ainda não achou)
            if (!basePrice) {
                const leftovers = pricesFound.filter(p => !p.assigned);
                if (leftovers.length > 0) {
                    basePrice = { val: leftovers[0].val };
                }
            }

            return { title, basePrice, offers };
        }

        function renderItemCard(container, id, data, raw) {
            const div = document.createElement('div');
            div.className = "result-card animate-fade-in";

            let baseHtml = "";
            if (data.basePrice) {
                baseHtml = `
                    <div class="price-card style-base">
                        <span class="tag">PREÇO BASE</span>
                        <span class="price-val">R$ ${fmt(data.basePrice.val)}</span>
                    </div>
                `;
            } else {
                baseHtml = `
                    <div class="price-card bg-slate-50 border-slate-200 opacity-50">
                        <span class="tag bg-slate-200 text-slate-500">SEM BASE</span>
                        <span class="price-val text-slate-400">---</span>
                    </div>
                `;
            }

            let offersHtml = data.offers.map(o => `
                <div class="price-card ${o.css}">
                    <span class="tag">${o.type}</span>
                    <span class="price-val">R$ ${fmt(o.val)}</span>
                </div>
            `).join('');

            div.innerHTML = `
                <div class="card-header">
                    <span class="font-bold text-sm text-slate-700">ITEM ID: ${id}</span>
                </div>
                <div class="p-6">
                    <span class="section-label">PRODUTO</span>
                    <div class="title-box">${data.title}</div>
                    <span class="section-label">PREÇOS</span>
                    <div class="price-grid">
                        ${baseHtml}
                        ${offersHtml}
                    </div>
                    <div class="debug-text">RAW: ${raw}</div>
                </div>
            `;
            container.prepend(div);
        }

        const fmt = n => n.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    </script>
</body>
</html>
