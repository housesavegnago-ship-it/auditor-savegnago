<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor V44 - Diretor de Arte</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .drop-zone { border: 2px dashed #64748b; border-radius: 12px; transition: all 0.2s; background-color: #f8fafc; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .drop-zone:hover { border-color: #ef4444; background-color: #fef2f2; } /* Vermelho Savegnago */
        .scroll-area { overflow-y: auto; height: 100%; }
        
        .result-card { background: white; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .result-header { padding: 10px 12px; background: #e2e8f0; border-bottom: 1px solid #cbd5e1; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #334155; }
        .result-body { padding: 15px; font-size: 13px; line-height: 1.6; }
        
        /* Estilo das Etiquetas */
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-ok { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .badge-err { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-warn { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        
        /* Mensagens de Erro/Sucesso */
        .err-item { background: #fff1f2; border-left: 4px solid #ef4444; padding: 10px; margin-bottom: 8px; border-radius: 4px; }
        .ok-item { background: #f0fdf4; border-left: 4px solid #22c55e; padding: 8px; margin-bottom: 6px; border-radius: 4px; color: #15803d; opacity: 0.8; }
        
        .correction-msg { font-weight: 800; color: #b91c1c; display: block; margin-top: 4px; font-size: 12px; text-transform: uppercase; }
        .divergence-info { color: #7f1d1d; font-size: 11px; margin-top: 2px; }
        
        .scan-text { font-family: monospace; font-size: 10px; color: #94a3b8; margin-top: 8px; border-top: 1px dashed #e2e8f0; padding-top: 4px; word-break: break-all; }
        .file-tag { font-family: monospace; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 11px; color: #475569; font-weight: bold; }
        
        .id-circle { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: #ef4444; color: white; border-radius: 50%; font-size: 11px; margin-right: 8px; font-weight: bold; }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-red-700 text-white p-3 h-14 flex justify-between items-center shrink-0 shadow-md z-10">
        <div class="flex items-center gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/2910/2910768.png" class="w-8 h-8 bg-white rounded p-1">
            <div>
                <h1 class="font-bold text-base leading-none">Auditor V44</h1>
                <p class="text-[10px] text-red-200">Relatório de Ajuste (Google Vision)</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2 bg-red-800 p-1 rounded border border-red-600">
             <i class="fa-solid fa-key text-red-300 ml-2 text-xs"></i>
             <input type="password" id="apiKeyInput" class="bg-transparent border-none text-xs text-white w-24 placeholder-red-300/50 focus:ring-0" placeholder="API Key Vision...">
             <button onclick="saveKey()" class="bg-red-950 hover:bg-red-900 text-white text-[10px] font-bold px-2 py-1 rounded transition">SALVAR</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[30%] bg-white border-r border-gray-200 flex flex-col z-20 shadow-xl p-4 gap-3">
            <div class="flex flex-col h-1/2">
                <label class="font-bold text-gray-700 mb-1 text-xs flex justify-between">
                    <span>1. Lista com IDs (Todos os Preços)</span>
                    <button onclick="document.getElementById('listInput').value = ''" class="text-[10px] text-red-500 hover:text-red-700 font-bold uppercase"><i class="fa-solid fa-trash-can mr-1"></i>Limpar</button>
                </label>
                <textarea id="listInput" class="flex-1 p-3 border rounded-lg bg-gray-50 text-xs font-mono resize-none focus:ring-2 focus:ring-red-500 outline-none" placeholder="1 - Cerveja
R$ 5,00
Nesta embalagem R$ 4,90
Save Ganhe R$ 4,50

5 - Feijão..."></textarea>
            </div>

            <div class="flex flex-col h-1/2">
                <label class="font-bold text-gray-700 mb-1 text-xs">2. Imagens (Nome P1, P5...)</label>
                <div id="dropZone" class="drop-zone h-full p-2 text-center group relative">
                    <div id="dropContent">
                        <i class="fa-solid fa-images text-3xl text-slate-300 group-hover:text-red-500 mb-2 transition-colors"></i>
                        <p class="text-xs text-gray-500 font-medium">Arraste os Encartes</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                </div>
            </div>

            <button id="startBtn" onclick="processQueue()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold shadow-md transition text-xs flex justify-center items-center gap-2">
                <i class="fa-solid fa-check-double"></i> Auditar Preços
            </button>
        </div>

        <div class="w-[70%] bg-slate-50 flex flex-col relative overflow-hidden">
            <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
                <div class="w-12 h-12 border-4 border-red-300 border-t-red-800 rounded-full animate-spin mb-3"></div>
                <div id="loadingText" class="text-red-900 font-bold text-sm animate-pulse">Processando...</div>
            </div>

            <div class="p-3 bg-white border-b border-gray-200 font-bold text-gray-700 shadow-sm flex justify-between text-sm">
                <span>Relatório de Divergências</span>
            </div>
            
            <div class="scroll-area p-6" id="resultsArea">
                <div class="text-center text-gray-400 mt-20 text-sm italic">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Cole a lista e as imagens para conferir.
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputField = document.getElementById('apiKeyInput');
        window.onload = () => { if(localStorage.getItem('vision_key')) inputField.value = localStorage.getItem('vision_key'); };
        function saveKey() { localStorage.setItem('vision_key', inputField.value.trim()); alert("Chave Salva!"); }
        function getKey() { return localStorage.getItem('vision_key') || inputField.value.trim(); }

        let fileQueue = [];
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const dropContent = document.getElementById('dropContent');
        
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);
        dropZone.ondragover = (e) => { e.preventDefault(); };
        dropZone.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };

        function handleFiles(files) {
            fileQueue = Array.from(files);
            dropContent.innerHTML = `
                <div class="bg-white w-full h-full flex flex-col items-center justify-center rounded border border-red-200">
                    <i class="fa-solid fa-layer-group text-red-600 text-2xl mb-1"></i>
                    <span class="text-xs font-bold text-slate-700">${fileQueue.length} arquivo(s)</span>
                </div>`;
        }

        async function processQueue() {
            const key = getKey();
            const listTxt = document.getElementById('listInput').value;
            
            if(!key) return alert("Falta a API Key!");
            if(!listTxt) return alert("Falta a lista numerada!");
            if(fileQueue.length === 0) return alert("Sem imagens!");

            // Parse Multi-Preço
            const products = parseListMultiPrice(listTxt);
            if(Object.keys(products).length === 0) return alert("Não encontrei IDs na lista (Ex: '1 - Arroz').");

            const overlay = document.getElementById('loadingOverlay');
            const resArea = document.getElementById('resultsArea');
            if(resArea.innerText.includes('Cole a lista')) resArea.innerHTML = '';
            
            overlay.classList.remove('hidden');

            for(let i=0; i<fileQueue.length; i++) {
                const file = fileQueue[i];
                document.getElementById('loadingText').innerText = `Conferindo ${i+1}/${fileQueue.length}...`;
                
                try {
                    await analyzeWithVisionV44(key, file, products, resArea);
                } catch (err) {
                    resArea.innerHTML = `<div class="bg-red-100 p-3 mb-2 text-red-800 text-xs rounded border border-red-200"><strong>Erro:</strong> ${err.message}</div>` + resArea.innerHTML;
                }
            }
            overlay.classList.add('hidden');
            fileQueue = [];
            dropContent.innerHTML = `<i class="fa-solid fa-check text-red-600 text-2xl"></i><div class="text-xs font-bold text-red-700">Concluído!</div>`;
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // --- PARSER MULTI-PREÇO ---
        // Captura TODOS os preços de um bloco de ID
        function parseListMultiPrice(txt) {
            const map = {};
            let currentId = null;
            let currentName = "";
            
            txt.split('\n').forEach(line => {
                line = line.trim();
                if(!line) return;

                const startMatch = line.match(/^(\d+)\s*-\s*(.+)/);
                if(startMatch) {
                    currentId = parseInt(startMatch[1]).toString();
                    currentName = startMatch[2];
                    map[currentId] = { name: currentName, prices: [] };
                    return;
                }
                
                if(currentId && map[currentId]) {
                    // Busca qualquer coisa que pareça preço: R$ XX,XX ou XX,XX
                    const priceMatches = line.match(/(?:R\$\s*)?([\d.]+,[\d]{2})/g);
                    if(priceMatches) {
                        priceMatches.forEach(p => {
                            const val = parseFloat(p.replace(/[R$\s]/g,'').replace('.','').replace(',','.'));
                            // Pega o contexto (ex: "Nesta embalagem")
                            // Remove o preço da linha para ficar só o texto
                            let context = line.replace(p, '').replace('R$', '').trim();
                            if(context.length < 2) context = "Preço Base"; // Se linha vazia, assume base
                            
                            map[currentId].prices.push({
                                val: val,
                                context: context
                            });
                        });
                    }
                }
            });
            return map;
        }

        async function analyzeWithVisionV44(key, file, productMap, container) {
            const idMatch = file.name.match(/[Pp]0*(\d+)/);
            
            if(!idMatch) {
                createCard(container, file.name, "IGNORADO", `<div class="text-slate-500 text-xs">Sem ID (P1, P5...) no nome.</div>`, "badge-warn");
                return;
            }

            const fileId = parseInt(idMatch[1]).toString();
            const target = productMap[fileId];

            if(!target) {
                createCard(container, file.name, "SEM LISTA", `<div class="text-slate-500 text-xs">Item <b>${fileId}</b> não está na lista.</div>`, "badge-warn");
                return;
            }

            const base64 = await toBase64(file);
            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] })
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            
            const rawText = data.responses[0]?.fullTextAnnotation?.text || "";
            
            // Extrai preços da imagem
            const imagePrices = [];
            const matches = rawText.match(/[\dOQS]{1,4}[.,][\dOQS]{2}\b/g) || [];
            matches.forEach(s => {
                let c = s.toUpperCase().replace(/[OQ]/g,'0').replace(/[S]/g,'5');
                let val = parseFloat(c.replace(/[^0-9,]/g,'').replace(',','.'));
                if (val >= 2020 && val <= 2030 && !rawText.includes('$' + s)) return;
                imagePrices.push(val);
            });

            // COMPARAÇÃO
            let html = '';
            let allCorrect = true;

            // Para cada preço exigido na lista
            target.prices.forEach(req => {
                const found = imagePrices.some(v => Math.abs(v - req.val) < 0.05);
                
                if(found) {
                    html += `
                        <div class="ok-item">
                            <div class="font-bold text-xs"><i class="fa-solid fa-check"></i> R$ ${fmtMoney(req.val)}</div>
                            <div class="text-[10px]">${req.context}</div>
                        </div>`;
                } else {
                    allCorrect = false;
                    // Tenta achar o preço errado (Divergência)
                    // Pega o primeiro preço da imagem que não esteja na lista de corretos
                    // Ou apenas mostra "Não encontrado" se não tiver nada perto
                    
                    // Estratégia simples: Mostrar o que tem na imagem
                    const divergentPrices = imagePrices.filter(p => !target.prices.some(t => Math.abs(t.val - p) < 0.05));
                    let divergenceMsg = divergentPrices.length > 0 
                        ? `Encontrei: ${divergentPrices.map(d => 'R$ '+fmtMoney(d)).join(', ')}` 
                        : "Valor não encontrado";

                    html += `
                        <div class="err-item">
                            <div class="font-bold text-xs text-red-900">${req.context}</div>
                            <span class="correction-msg">IMAGEM - AJUSTAR PREÇO - R$ ${fmtMoney(req.val)}</span>
                            <div class="divergence-info"><i class="fa-solid fa-magnifying-glass"></i> ${divergenceMsg}</div>
                        </div>`;
                }
            });

            // Se não tinha preços cadastrados na lista para esse item
            if(target.prices.length === 0) {
                html = `<div class="text-xs text-orange-600">Nenhum preço detectado na lista para este item.</div>`;
                allCorrect = false;
            }

            const statusBadge = allCorrect ? "APROVADO" : "CORRIGIR";
            const badgeClass = allCorrect ? "badge-ok" : "badge-err";

            createCard(container, file.name, statusBadge, `
                <div class="font-bold text-xs mb-2 text-slate-700 border-b pb-1">
                    <span class="id-circle">${fileId}</span> ${target.name}
                </div>
                ${html}
            `, badgeClass, imagePrices.join(' | '));
        }

        function createCard(container, title, badgeText, contentHtml, badgeClass, debugInfo = "") {
            const div = document.createElement('div');
            div.className = 'result-card animate-fade-in';
            div.innerHTML = `
                <div class="result-header">
                    <span class="file-tag"><i class="fa-solid fa-file mr-1"></i>${title}</span>
                    <span class="badge ${badgeClass}">${badgeText}</span>
                </div>
                <div class="result-body">
                    ${contentHtml}
                    ${debugInfo ? `<div class="scan-text">Leitura bruta: ${debugInfo}</div>` : ''}
                </div>
            `;
            container.prepend(div);
        }

        const fmtMoney = n => n.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    </script>
</body>
</html>
