<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Visual V39 - Savegnago</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e293b; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: white; }
        
        /* Layout */
        .workspace { display: flex; height: 100%; overflow: hidden; }
        .sidebar { width: 350px; background: #0f172a; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; }
        .canvas-area { flex: 1; position: relative; background: #334155; overflow: hidden; cursor: crosshair; display: flex; align-items: center; justify-content: center; }
        
        /* Lista de Produtos */
        .product-item { padding: 12px; border-bottom: 1px solid #1e293b; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .product-item:hover { background: #1e293b; }
        .product-item.active { background: #1e293b; border-left-color: #3b82f6; }
        .product-item.done { opacity: 0.5; border-left-color: #22c55e; }
        
        /* Lupa e Overlay */
        #magnifier {
            position: absolute; pointer-events: none; border: 3px solid #fff; border-radius: 50%;
            width: 250px; height: 250px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none; z-index: 50; background: #fff;
        }
        #magnifier img { position: absolute; max-width: none; }
        
        /* Etiqueta Flutuante (O Pulo do Gato) */
        #floatingLabel {
            position: absolute; pointer-events: none; z-index: 60;
            background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 15px; border-radius: 8px;
            font-weight: bold; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none; white-space: nowrap; border: 2px solid #fbbf24;
            transform: translate(20px, 20px); /* Ao lado do mouse */
        }
        
        /* Dropzone */
        .drop-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dashed-box { border: 3px dashed #475569; padding: 40px; border-radius: 20px; text-align: center; transition: all 0.2s; }
        .dashed-box:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }

        /* Controles */
        .control-panel { padding: 15px; background: #1e293b; border-top: 1px solid #334155; }
        textarea { background: #0f172a; color: #cbd5e1; border: 1px solid #334155; }
    </style>
</head>
<body>

    <header class="h-14 bg-slate-900 border-b border-slate-700 flex items-center px-4 justify-between shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded"><i class="fa-solid fa-eye text-white"></i></div>
            <div>
                <h1 class="font-bold text-sm leading-none">Auditor Visual V39</h1>
                <p class="text-[10px] text-slate-400">Conferência Assistida (Sem Falhas)</p>
            </div>
        </div>
        <div class="flex items-center gap-4 text-xs text-slate-400">
            <span><kbd class="bg-slate-700 px-1 rounded">Espaço</kbd> Aprovar</span>
            <span><kbd class="bg-slate-700 px-1 rounded">X</kbd> Pular</span>
            <button onclick="resetAll()" class="text-red-400 hover:text-red-300 ml-4 font-bold">NOVA LISTA</button>
        </div>
    </header>

    <div class="workspace">
        
        <div class="sidebar">
            <div id="inputArea" class="p-4 flex flex-col h-full">
                <label class="text-xs font-bold text-slate-400 mb-2">1. Cole a Lista aqui:</label>
                <textarea id="listInput" class="flex-1 rounded p-2 text-xs font-mono mb-4 focus:ring-2 focus:ring-blue-600 outline-none resize-none" placeholder="Arroz - R$ 20,90..."></textarea>
                <button onclick="startAudit()" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded font-bold shadow-lg transition">
                    INICIAR CONFERÊNCIA
                </button>
            </div>
            
            <div id="checklistArea" class="flex-1 overflow-y-auto hidden">
                </div>
            
            <div id="progressPanel" class="hidden p-4 bg-slate-800 border-t border-slate-700">
                <div class="flex justify-between text-xs mb-1 font-bold">
                    <span id="progressText">0/0</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-green-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <div class="canvas-area" id="canvasArea">
            
            <div id="dropOverlay" class="drop-overlay">
                <div class="dashed-box" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-cloud-arrow-up text-5xl text-slate-400 mb-4"></i>
                    <h2 class="text-xl font-bold text-white mb-2">Arraste a Imagem do Encarte</h2>
                    <p class="text-sm text-slate-400">Suporta PNG, JPG, JPEG</p>
                    <input type="file" id="fileInput" class="hidden" accept="image/*">
                </div>
            </div>

            <img id="mainImage" class="max-w-full max-h-full object-contain opacity-50 transition-opacity duration-300">
            
            <div id="magnifier"><img id="magnifierImg"></div>
            
            <div id="floatingLabel">
                <div class="text-[10px] text-yellow-200 uppercase tracking-wider mb-1">Procure por:</div>
                <div id="floatPrice" class="text-3xl text-white font-mono">R$ 00,00</div>
                <div id="floatName" class="text-xs text-gray-300 max-w-[200px] truncate">Nome do Produto</div>
            </div>

        </div>
    </div>

    <script>
        // ESTADO
        let products = [];
        let currentIndex = 0;
        let zoomLevel = 2.5; // Zoom da lupa

        // ELEMENTOS
        const dropOverlay = document.getElementById('dropOverlay');
        const mainImage = document.getElementById('mainImage');
        const fileInput = document.getElementById('fileInput');
        const magnifier = document.getElementById('magnifier');
        const magImg = document.getElementById('magnifierImg');
        const floatLabel = document.getElementById('floatingLabel');
        
        // --- 1. UPLOAD IMAGEM ---
        const handleFile = (file) => {
            if(!file) return;
            const url = URL.createObjectURL(file);
            mainImage.src = url;
            magImg.src = url;
            dropOverlay.classList.add('hidden');
            mainImage.classList.remove('opacity-50'); // Ativa imagem
        };

        // Eventos Drag & Drop
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        // --- 2. PARSE LISTA ---
        function startAudit() {
            const txt = document.getElementById('listInput').value;
            if(!txt) return alert("Cole a lista primeiro!");
            
            products = [];
            
            // Regex melhorada para capturar lista do Savegnago
            txt.split('\n').forEach(line => {
                const mainM = line.match(/(.+) – R\$ ([\d,.]+)/i);
                if(mainM && !line.trim().startsWith('(')) {
                    products.push({
                        name: mainM[1].trim(),
                        price: mainM[2],
                        type: 'BASE',
                        status: 'pending'
                    });
                } else if(line.trim().startsWith('(') && products.length > 0) {
                    const extraM = line.match(/R\$ ([\d,.]+)/);
                    if(extraM) {
                        products.push({
                            name: products[products.length-1].name + " (Cartão)",
                            price: extraM[1],
                            type: 'CARTÃO',
                            status: 'pending'
                        });
                    }
                }
            });

            if(products.length === 0) return alert("Não encontrei preços na lista. Verifique a formatação.");

            // UI Changes
            document.getElementById('inputArea').classList.add('hidden');
            document.getElementById('checklistArea').classList.remove('hidden');
            document.getElementById('progressPanel').classList.remove('hidden');
            
            renderList();
            activateItem(0);
        }

        // --- 3. RENDERIZAÇÃO DA LISTA ---
        function renderList() {
            const container = document.getElementById('checklistArea');
            container.innerHTML = '';
            
            products.forEach((p, idx) => {
                const el = document.createElement('div');
                el.className = `product-item ${idx === currentIndex ? 'active' : ''} ${p.status === 'ok' ? 'done' : ''}`;
                el.onclick = () => activateItem(idx);
                
                // Cor do Preço
                const priceColor = p.type === 'CARTÃO' ? 'text-yellow-400' : 'text-green-400';
                const icon = p.status === 'ok' ? '<i class="fa-solid fa-check text-green-500"></i>' : (idx === currentIndex ? '<i class="fa-solid fa-crosshairs text-blue-400 animate-pulse"></i>' : '<i class="fa-regular fa-circle text-slate-600"></i>');

                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 mr-2">
                            <div class="text-[10px] text-slate-400 uppercase font-bold">${p.type}</div>
                            <div class="text-xs font-medium text-slate-200 leading-tight">${p.name}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold ${priceColor}">R$ ${p.price}</div>
                            <div class="mt-1 text-xs">${icon}</div>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
            
            // Scroll para o item ativo
            const activeEl = container.children[currentIndex];
            if(activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            updateProgress();
        }

        function activateItem(idx) {
            currentIndex = idx;
            renderList();
            
            // Atualiza Label Flutuante
            const p = products[idx];
            document.getElementById('floatPrice').innerText = `R$ ${p.price}`;
            document.getElementById('floatPrice').className = `text-3xl font-mono ${p.type === 'CARTÃO' ? 'text-yellow-400' : 'text-green-400'}`;
            document.getElementById('floatName').innerText = p.name;
        }

        function updateProgress() {
            const done = products.filter(p => p.status === 'ok').length;
            const total = products.length;
            const pct = Math.round((done / total) * 100);
            
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${done}/${total}`;
            document.getElementById('percentText').innerText = `${pct}%`;
        }

        // --- 4. LUPA E MOUSE ---
        const canvasArea = document.getElementById('canvasArea');

        canvasArea.addEventListener('mousemove', (e) => {
            if(!mainImage.src) return;

            // Mostra elementos
            magnifier.style.display = 'block';
            floatLabel.style.display = 'block';

            // Posição do Mouse relativa à imagem
            const rect = mainImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Se mouse fora da imagem, esconde
            if (x < 0 || x > rect.width || y < 0 || y > rect.height) {
                magnifier.style.display = 'none';
                floatLabel.style.display = 'none';
                return;
            }

            // Move Lupa
            magnifier.style.left = (e.clientX + 20) + 'px';
            magnifier.style.top = (e.clientY - 125) + 'px'; // Centralizado verticalmente

            // Move Label (Gabarito)
            floatLabel.style.left = (e.clientX + 30) + 'px';
            floatLabel.style.top = (e.clientY + 130) + 'px'; // Abaixo da lupa

            // Lógica do Zoom da Imagem dentro da Lupa
            // Calcula a proporção da imagem original vs imagem na tela
            const ratioX = mainImage.naturalWidth / rect.width;
            const ratioY = mainImage.naturalHeight / rect.height;

            magImg.style.width = (rect.width * zoomLevel * ratioX) + 'px';
            magImg.style.height = (rect.height * zoomLevel * ratioY) + 'px';
            
            // Posiciona a imagem dentro da lupa para coincidir
            magImg.style.left = -(x * zoomLevel * ratioX - 125) + 'px';
            magImg.style.top = -(y * zoomLevel * ratioY - 125) + 'px';
        });

        // Controles de Teclado
        document.addEventListener('keydown', (e) => {
            if(products.length === 0) return;

            if(e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                products[currentIndex].status = 'ok';
                if(currentIndex < products.length - 1) activateItem(currentIndex + 1);
                else renderList(); // Só atualiza UI se for o último
            }
            
            if(e.code === 'KeyX') {
                if(currentIndex < products.length - 1) activateItem(currentIndex + 1);
            }
            
            if(e.code === 'ArrowUp') {
                e.preventDefault();
                if(currentIndex > 0) activateItem(currentIndex - 1);
            }
            if(e.code === 'ArrowDown') {
                e.preventDefault();
                if(currentIndex < products.length - 1) activateItem(currentIndex + 1);
            }
        });

        // Zoom com Scroll do Mouse
        canvasArea.addEventListener('wheel', (e) => {
            e.preventDefault();
            if(e.deltaY < 0) zoomLevel += 0.5;
            else zoomLevel = Math.max(1, zoomLevel - 0.5);
        });

        function resetAll() {
            if(confirm("Reiniciar tudo?")) location.reload();
        }

    </script>
</body>
</html>
