<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor V84 - ID Universal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: #1f2937; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; background: #f1f5f9; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .drop-zone:hover { border-color: #2563eb; background: #eff6ff; }

        .result-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        
        .comp-table { width: 100%; text-align: left; font-size: 13px; border-collapse: collapse; }
        .comp-table th { background: #f1f5f9; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; padding: 8px 12px; font-size: 11px; text-transform: uppercase; }
        .comp-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .comp-table tr:last-child td { border-bottom: none; }

        .price-tag { font-family: monospace; font-weight: 800; font-size: 14px; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        
        /* DIFF TEXT STYLES */
        .diff-word { display: inline-block; margin-right: 4px; }
        .diff-found { color: #16a34a; font-weight: bold; } 
        .diff-missing { color: #dc2626; text-decoration: line-through; opacity: 0.6; } 
        
        /* LINHA DE TITULO DA LISTA */
        .list-title-text { font-weight: 600; color: #1e293b; font-size: 12px; }

        .status-ok { color: #16a34a; font-weight: bold; }
        .status-err { color: #dc2626; font-weight: bold; }
        .status-warn { color: #d97706; font-weight: bold; }

        .bg-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-err { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .bg-miss { background: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; }
        .bg-ref { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }

        .badge { font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; }
        .badge-pass { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge-fail { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .debug-panel { font-size: 10px; color: #6b7280; background: #f9fafb; padding: 8px; border-top: 1px solid #e2e8f0; display: none; }
        
        .api-select { background: #374151; border: 1px solid #4b5563; color: white; font-size: 12px; padding: 4px 8px; border-radius: 4px; outline: none; }
        .api-select:focus { border-color: #3b82f6; }

        /* COUNTER BOX */
        .usage-box { background: #111827; border: 1px solid #374151; border-radius: 6px; padding: 4px 10px; display: flex; flex-direction: column; min-width: 120px; }
        .usage-label { font-size: 9px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
        .usage-val { font-size: 12px; font-weight: bold; color: #10b981; font-family: monospace; }
        .progress-bg { height: 3px; background: #374151; width: 100%; margin-top: 2px; border-radius: 2px; }
        .progress-fill { height: 100%; background: #10b981; border-radius: 2px; transition: width 0.3s; }
    </style>
</head>
<body class="text-slate-800">

    <header class="header">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded text-white"><i class="fa-solid fa-robot"></i></div>
            <div>
                <h1 class="font-bold text-lg leading-none">Auditor V84</h1>
                <p class="text-[10px] text-gray-400">ID Universal</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="usage-box" title="Estimativa de uso neste computador hoje">
                <span class="usage-label">USO DIÁRIO (Local)</span>
                <span id="usageCounter" class="usage-val">0 / 1000</span>
                <div class="progress-bg"><div id="usageBar" class="progress-fill" style="width: 0%"></div></div>
            </div>

            <div class="flex flex-col items-end border-l border-gray-700 pl-4">
                <span class="text-[10px] text-gray-400 font-bold mb-1">MOTOR OCR:</span>
                <select id="apiSelector" class="api-select" onchange="toggleApiKeyInput()">
                    <option value="vision">Google Vision (Padrão)</option>
                    <option value="freeocr">Free OCR (Grátis)</option>
                </select>
            </div>

            <div id="visionKeyContainer" class="flex gap-2">
                <input type="password" id="apiKey" class="bg-gray-800 border border-gray-700 text-white text-xs p-1.5 rounded w-32 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Cole sua API Key aqui...">
                <button onclick="saveKey()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded">SALVAR</button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[35%] bg-white border-r border-slate-200 flex flex-col p-4 gap-4 shadow-xl z-10">
            <div class="flex-1 flex flex-col">
                <label class="text-xs font-bold text-slate-500 mb-1 flex justify-between">
                    1. GABARITO (LISTA)
                    <span class="text-blue-600 cursor-pointer hover:underline" onclick="document.getElementById('listInput').value = ''">Limpar Texto</span>
                </label>
                <textarea id="listInput" class="flex-1 border rounded-lg p-3 text-xs font-mono bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Cole a lista aqui..."></textarea>
            </div>
            
            <div class="h-32">
                <div id="dropZone" class="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                    <div class="text-xs font-bold text-slate-600">2. ARRASTE IMAGENS</div>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="runAudit()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg font-bold shadow transition text-sm flex justify-center items-center gap-2">
                    <i class="fa-solid fa-play"></i> AUDITAR
                </button>
                <button onclick="clearImages()" class="w-16 bg-red-600 hover:bg-red-500 text-white py-3 rounded-lg font-bold shadow transition text-sm flex justify-center items-center" title="Limpar">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>

        <div class="w-[65%] bg-slate-50 relative flex flex-col">
            <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div>
                <div id="loadingText" class="text-sm font-bold text-blue-900 animate-pulse">Iniciando motor...</div>
            </div>

            <div id="resultsArea" class="flex-1 overflow-y-auto p-6">
                <div class="text-center mt-20 text-slate-400 text-sm italic">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Cole a lista e arraste as imagens.
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKey');
        const apiSelector = document.getElementById('apiSelector');
        const visionContainer = document.getElementById('visionKeyContainer');
        const usageCounter = document.getElementById('usageCounter');
        const usageBar = document.getElementById('usageBar');

        // --- SISTEMA DE COTA DIÁRIA ---
        function updateUsageDisplay() {
            const today = new Date().toDateString();
            const storedDate = localStorage.getItem('usage_date');
            if (storedDate !== today) { localStorage.setItem('usage_date', today); localStorage.setItem('usage_count', '0'); }
            const count = parseInt(localStorage.getItem('usage_count') || '0');
            const limit = 1000;
            const pct = Math.min((count / limit) * 100, 100);
            usageCounter.innerText = `${count} / ${limit}`;
            usageBar.style.width = `${pct}%`;
            if(pct > 90) usageCounter.style.color = '#ef4444'; else usageCounter.style.color = '#10b981';
        }
        function incrementUsage() { const count = parseInt(localStorage.getItem('usage_count') || '0'); localStorage.setItem('usage_count', count + 1); updateUsageDisplay(); }
        if(localStorage.getItem('vision_key')) apiKeyInput.value = localStorage.getItem('vision_key');
        updateUsageDisplay();

        function saveKey() { localStorage.setItem('vision_key', apiKeyInput.value.trim()); alert("Chave Vision Salva!"); }
        function toggleApiKeyInput() { visionContainer.style.display = (apiSelector.value === 'vision') ? 'flex' : 'none'; }
        toggleApiKeyInput();

        const FREE_OCR_KEY = 'K87864832788957';
        let files = [];
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => { files = Array.from(e.target.files); dropZone.innerHTML = `<div class="text-blue-600 font-bold">${files.length} Arquivos</div>`; };
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#2563eb'; };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#9ca3af'; files = Array.from(e.dataTransfer.files); dropZone.innerHTML = `<div class="text-blue-600 font-bold">${files.length} Arquivos</div>`; };

        function clearImages() {
            files = []; fileInput.value = '';
            dropZone.innerHTML = `<i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i><div class="text-xs font-bold text-slate-600">2. ARRASTE IMAGENS</div><input type="file" id="fileInput" multiple accept="image/*" class="hidden">`;
            document.getElementById('resultsArea').innerHTML = `<div class="text-center mt-20 text-slate-400 text-sm italic"><i class="fa-solid fa-check mr-2 text-green-500"></i> Pronto.</div>`;
        }

        // --- DETECTOR UNIVERSAL DE ID V84 ---
        function extractIdFromFilename(filename) {
            // 1. Tenta padrão explícito P1, p01
            let match = filename.match(/[Pp]0*(\d+)/);
            if (match) return match[1];

            // 2. Tenta separadores (-1, _1, " 1") antes da extensão
            // Ex: "oferta-1.jpg", "foto_5.png", "item 10.jpeg"
            match = filename.match(/[-_\s]0*(\d+)\./);
            if (match) return match[1];

            // 3. Tenta número solto no final do arquivo (antes do ponto)
            // Ex: "imagem15.jpg", "1.jpg"
            match = filename.match(/0*(\d+)\.[a-zA-Z0-9]+$/);
            if (match) return match[1];

            return null;
        }

        async function runAudit() {
            const listTxt = document.getElementById('listInput').value;
            const mode = apiSelector.value;

            if(!listTxt.trim() || files.length === 0) return alert("Faltam dados!");
            if(mode === 'vision' && !apiKeyInput.value.trim()) return alert("Salve a API Key do Vision!");

            const listData = parseListV76(listTxt);
            if(Object.keys(listData).length === 0) return alert("Lista inválida.");

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').innerText = mode === 'vision' ? "Google Vision..." : "Free OCR Turbo...";
            const container = document.getElementById('resultsArea');
            container.innerHTML = '';

            for(const file of files) {
                // *** NOVA CHAMADA DE ID ***
                const id = extractIdFromFilename(file.name);
                
                if(!id) { renderError(container, file.name, "ID não encontrado no nome do arquivo (Use: P1, -1, _1 ou 1.jpg)"); continue; }
                
                const gabarito = listData[id];
                if(!gabarito) { renderError(container, file.name, `ID ${id} identificado, mas não está na lista.`); continue; }

                try {
                    let imgData;
                    if (mode === 'vision') {
                        imgData = await processImageVision(file, apiKeyInput.value.trim());
                        incrementUsage();
                    } else {
                        imgData = await processImageFreeOCR(file);
                    }
                    
                    compareAndRenderV82(container, id, gabarito, imgData, mode);
                } catch(e) { renderError(container, file.name, e.message); }
            }
            document.getElementById('loading').classList.add('hidden');
        }

        // --- ENGINES ---
        async function processImageVision(file, key) {
            const base64 = await toBase64(file);
            const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, { method: 'POST', body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] }) });
            const json = await res.json();
            return extractPricesFromTextV82(json.responses[0]?.fullTextAnnotation?.text || "", 80);
        }

        async function processImageFreeOCR(file) {
            let base64 = await toBase64(file);
            if (file.size > 900 * 1024) base64 = await compressImage(base64);
            const formData = new FormData();
            formData.append("base64Image", "data:image/jpeg;base64," + base64);
            formData.append("language", "por");
            formData.append("apikey", FREE_OCR_KEY);
            formData.append("OCREngine", "2"); 
            formData.append("scale", "true"); 
            const res = await fetch("https://api.ocr.space/parse/image", { method: 'POST', body: formData });
            const json = await res.json();
            if (json.IsErroredOnProcessing) throw new Error("Free OCR Error: " + json.ErrorMessage);
            return extractPricesFromTextV82(json.ParsedResults?.[0]?.ParsedText || "", 150);
        }

        // --- CORE LÓGICO ---
        function extractPricesFromTextV82(rawText, lookBackChars) {
            let clean = rawText.replace(/\r/g, '').replace(/([0-9SBOlIZ]{1,3})[,.]([0-9SBOlIZ]{2})\b/g, (match) => match.replace(/S/g,'5').replace(/[O]/g,'0').replace(/B/g,'8').replace(/[lI]/g,'1').replace(/Z/g,'2'));
            let extractedTitle = clean.match(/^(.*?)(?=R\$|\d+[,.]\d{2})/s)?.[1] || "";
            ["SAVE", "GANHE", "NOSSO", "CLUBE", "OFERTA", "CLIENTE", "LEVANDO", "CARTÃO"].forEach(g => { const idx = extractedTitle.toUpperCase().indexOf(g); if(idx !== -1) extractedTitle = extractedTitle.substring(0, idx); });
            extractedTitle = extractedTitle.replace(/\n/g, ' ').trim();
            const pricesFound = [];
            const pRegex = /(\d{1,3}(?:\.\d{3})*)[,.](\d{2})\b/g;
            let m;
            while ((m = pRegex.exec(clean)) !== null) {
                const val = parseFloat(m[0].replace('.','').replace(',','.'));
                if(!(val >= 2020 && val <= 2030 && Number.isInteger(val))) pricesFound.push({ val, index: m.index });
            }
            let basePrice = null; const offers = []; let baseFound = false;
            const buyIdx = clean.toUpperCase().indexOf("COMPRAR");
            if(buyIdx !== -1) { const c = pricesFound.filter(p => p.index < buyIdx); if(c.length) { const p = c[c.length - 1]; basePrice = p.val; baseFound = true; pricesFound.splice(pricesFound.indexOf(p), 1); } }
            const iTriggers = [{ k: "SAVE", t: "SAVE GANHE" }, { k: "CARTÃO", t: "NOSSO CARTÃO" }, { k: "EMBALAGEM", t: "EMBALAGEM" }, { k: "LEVANDO", t: "EMBALAGEM" }, { k: "A PARTIR", t: "EMBALAGEM" }, { k: "UNIDADE", t: "EMBALAGEM" }];
            pricesFound.forEach(p => {
                const ctx = clean.substring(Math.max(0, p.index - lookBackChars), p.index).toUpperCase().replace(/\n/g,' ');
                let bestT = null, minD = 9999;
                for(const t of iTriggers) { const idx = ctx.lastIndexOf(t.k); if(idx !== -1) { const dist = ctx.length - idx; if (dist < minD) { minD = dist; bestT = t.t; } } }
                if(bestT && minD < 100) offers.push({ type: bestT, val: p.val }); else if(!baseFound) { basePrice = p.val; baseFound = true; }
            });
            return { title: extractedTitle, basePrice, offers, rawText: clean, rawNumbers: pricesFound };
        }

        // --- RENDER ---
        function compareAndRenderV82(container, id, gabarito, imagem, mode) {
            const rows = [];
            let errorCount = 0;
            const sim = checkTitleSimilarity(gabarito.title, imagem.title);
            const titleStatus = sim < 0.4 ? "ERRO" : (sim < 0.7 ? "WARN" : "OK");
            if (titleStatus === "ERRO") errorCount++;
            const titleDiffHtml = generateTitleDiffV82(gabarito.title, imagem.title);
            rows.push(rowTitleDouble(gabarito.title, titleDiffHtml, titleStatus, Math.round(sim * 100)));
            if (gabarito.basePrice) {
                if (imagem.basePrice) {
                    if (Math.abs(gabarito.basePrice - imagem.basePrice) < 0.05) rows.push(rowHtml("BASE", gabarito.basePrice, imagem.basePrice, "OK"));
                    else { rows.push(rowHtml("BASE", gabarito.basePrice, imagem.basePrice, "DIVERGENTE")); errorCount++; }
                } else { rows.push(rowHtml("BASE", gabarito.basePrice, null, "SUMIU")); errorCount++; }
            }
            gabarito.offers.forEach(req => {
                const matchType = imagem.offers.find(o => o.type === req.type);
                if (matchType) {
                    if (Math.abs(matchType.val - req.val) < 0.05) rows.push(rowHtml(req.type, req.val, matchType.val, "OK"));
                    else { rows.push(rowHtml(req.type, req.val, matchType.val, "DIVERGENTE")); errorCount++; }
                } else {
                    const matchVal = imagem.offers.find(o => Math.abs(o.val - req.val) < 0.05);
                    if(matchVal) { rows.push(rowHtml(req.type, req.val, matchVal.val, "WARN", `Achado como ${matchVal.type}`)); errorCount++; }
                    else { rows.push(rowHtml(req.type, req.val, null, "SUMIU")); errorCount++; }
                }
            });
            const status = errorCount === 0 ? "APROVADO" : "REPROVADO";
            const badgeClass = errorCount === 0 ? "badge-pass" : "badge-fail";
            const div = document.createElement('div');
            div.className = "result-card animate-fade-in";
            const debugId = `debug-${id}`;
            const engineLabel = mode === 'vision' ? 'Vision' : 'Free OCR';
            div.innerHTML = `<div class="card-header"><div><span class="font-bold text-sm text-slate-700">ID ${id}</span> <span class="text-[9px] text-gray-400">(${engineLabel})</span></div><span class="badge ${badgeClass}">${status}</span></div><table class="comp-table"><thead><tr><th>Item</th><th>Esperado</th><th>Encontrado</th><th>Status</th></tr></thead><tbody>${rows.join('')}</tbody></table><div class="text-center p-2 border-t border-slate-100"><button onclick="document.getElementById('${debugId}').style.display = 'block'" class="text-[10px] text-blue-500 hover:underline"><i class="fa-solid fa-microscope"></i> Debug</button></div><div id="${debugId}" class="debug-panel"><strong>Raw OCR Title:</strong> ${imagem.title}<br><strong>RAW Text:</strong> ${imagem.rawText.substring(0, 150)}...</div>`;
            container.prepend(div);
        }

        // --- AUXILIARES ---
        function generateTitleDiffV82(expected, found) {
            const expTokens = expected.split(/\s+/);
            const foundClean = found.toLowerCase();
            return expTokens.map(word => {
                const wClean = word.toLowerCase().replace(/[^\w]/g,'');
                if(wClean.length < 2) return `<span class="diff-word text-gray-400">${word}</span>`;
                if (foundClean.includes(wClean)) return `<span class="diff-word diff-found">${word}</span>`;
                else return `<span class="diff-word diff-missing">${word}</span>`;
            }).join(' ');
        }
        function rowTitleDouble(expected, diffHtml, status, pct) {
            let icon, stClass;
            if(status === "OK") { icon='✔'; stClass='status-ok'; } else if(status === "WARN") { icon='⚠'; stClass='status-warn'; } else { icon='✖'; stClass='status-err'; }
            return `<tr><td class="font-bold text-slate-600 align-top pt-3">TÍTULO (LISTA)</td><td colspan="2"><span class="list-title-text">${expected}</span></td><td rowspan="2" class="${stClass} align-middle border-l border-slate-100 pl-2"><div class="flex flex-col items-center"><span>${icon} ${status}</span><span class="text-[9px] text-gray-400">(${pct}%)</span></div></td></tr><tr><td class="font-bold text-slate-600 align-top pb-3 text-[10px]">TÍTULO (IMG)</td><td colspan="2" class="pb-3"><div class="text-[12px] leading-snug">${diffHtml}</div></td></tr>`;
        }
        function rowHtml(label, exp, found, status, obs="") { let icon, stClass, valHtml; const expFmt = fmt(exp); if (status === "OK") { icon = '✔'; stClass = 'status-ok'; valHtml = `<span class="price-tag bg-ok">R$ ${fmt(found)}</span>`; } else if (status === "DIVERGENTE") { icon = '✖'; stClass = 'status-err'; valHtml = `<span class="price-tag bg-err">R$ ${fmt(found)}</span>`; } else if (status === "WARN") { icon = '⚠'; stClass = 'status-warn'; valHtml = `<span class="price-tag bg-ref">R$ ${fmt(found)}</span> <span class="text-[9px]">${obs}</span>`; } else { icon = '✖'; stClass = 'status-err'; valHtml = `<span class="price-tag bg-miss">---</span>`; } return `<tr><td class="font-bold text-slate-600">${label}</td><td><span class="font-mono font-bold text-blue-800">R$ ${expFmt}</span></td><td>${valHtml}</td><td class="${stClass} border-l border-slate-100 pl-2">${icon} ${status}</td></tr>`; }
        function checkTitleSimilarity(exp, fnd) { const t=s=>s.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(w=>w.length>2); const eT=t(exp); const fT=fnd.toLowerCase(); if(eT.length===0)return 0; let m=0; eT.forEach(t=>{if(fT.includes(t))m++}); return m/eT.length; }
        function toBase64(f){return new Promise((r,j)=>{const d=new FileReader();d.onload=()=>r(d.result.split(',')[1]);d.onerror=j;d.readAsDataURL(f)})}
        function compressImage(b){return new Promise(r=>{const i=new Image();i.src="data:image/jpeg;base64,"+b;i.onload=()=>{const c=document.createElement('canvas');c.width=1000;c.height=i.height*(1000/i.width);c.getContext('2d').drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.7).split(',')[1])}})}
        function parseListV76(t){const m={};const l=t.split('\n');let c=null;l.forEach(x=>{x=x.trim();if(!x)return;const r=x.match(/^(\d+)\s*-\s*(.+)/);if(r){if(c)processListBlock(m,c);c={id:r[1],text:x}}else if(c)c.text+=" "+x});if(c)processListBlock(m,c);return m}
        function processListBlock(m,i){const t=i.text.replace(/\s+/g,' ').trim();let ti=t.match(/^(.*?)(?=\s\(red|–\s*R\$|R\$)/i)?.[1]?.replace(/^\d+\s*-\s*/,'').trim()||t;let bp=null;const o=[];const p=[];const r=/R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})/gi;let x;while((x=r.exec(t))!==null)p.push({v:parseFloat(x[1].replace('.','').replace(',','.')),i:x.index,a:false});const rm=t.match(/R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})\s*\(red/i);if(rm){const v=parseFloat(rm[1].replace('.','').replace(',','.'));const k=p.find(n=>Math.abs(n.v-v)<0.001);if(k){bp=k.v;k.a=true}}else{const dm=t.match(/–\s*R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})/);if(dm){const v=parseFloat(dm[1].replace('.','').replace(',','.'));const k=p.find(n=>Math.abs(n.v-v)<0.001);if(k){bp=k.v;k.a=true}}}const tr=[{k:"CARTÃO",t:"NOSSO CARTÃO"},{k:"SAVE",t:"SAVE GANHE"},{k:"EMBALAGEM",t:"EMBALAGEM"},{k:"SAI POR",t:"EMBALAGEM"},{k:"UNIDADE",t:"EMBALAGEM"},{k:"LEVANDO",t:"EMBALAGEM"}];p.forEach(n=>{if(n.a)return;const cx=t.substring(Math.max(0,n.i-80),n.i).toUpperCase();let bt=null,md=9999;tr.forEach(k=>{const ix=cx.lastIndexOf(k.k);if(ix!==-1&&(cx.length-ix)<md){md=cx.length-ix;bt=k.t}});if(bt&&md<60){o.push({type:bt,val:n.v});n.a=true}});if(!bp){const l=p.find(n=>!n.a);if(l)bp=l.v}m[i.id]={title:ti,basePrice:bp,offers:o}}
        function renderError(c,t,m){c.innerHTML+=`<div class="p-3 bg-red-100 text-red-800 text-xs rounded mb-2"><strong>${t}:</strong> ${m}</div>`}
        const fmt=n=>n.toLocaleString('pt-BR',{minimumFractionDigits:2});
    </script>
</body>
</html>
