<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor V78 - Turbo Free OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: #111827; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; background: #f1f5f9; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .drop-zone:hover { border-color: #3b82f6; background: #eff6ff; }

        .result-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        
        .comp-table { width: 100%; text-align: left; font-size: 13px; border-collapse: collapse; }
        .comp-table th { background: #f1f5f9; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; padding: 8px 12px; font-size: 11px; text-transform: uppercase; }
        .comp-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .comp-table tr:last-child td { border-bottom: none; }

        .price-tag { font-family: monospace; font-weight: 800; font-size: 14px; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        
        .status-ok { color: #16a34a; font-weight: bold; }
        .status-err { color: #dc2626; font-weight: bold; }
        .status-warn { color: #d97706; font-weight: bold; }

        .bg-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-err { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .bg-miss { background: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; }

        .badge { font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 12px; text-transform: uppercase; }
        .badge-pass { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge-fail { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .debug-panel { font-size: 10px; color: #6b7280; background: #f9fafb; padding: 8px; border-top: 1px solid #e2e8f0; display: none; }
        
        .api-select { background: #374151; border: 1px solid #4b5563; color: white; font-size: 12px; padding: 4px 8px; border-radius: 4px; outline: none; }
        .api-select:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="text-slate-800">

    <header class="header">
        <div class="flex items-center gap-3">
            <div class="bg-violet-600 p-1.5 rounded text-white"><i class="fa-solid fa-robot"></i></div>
            <div>
                <h1 class="font-bold text-lg leading-none">Auditor V78</h1>
                <p class="text-[10px] text-violet-200">Turbo Free OCR (Engine 2)</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-400 font-bold mb-1">MOTOR OCR:</span>
                <select id="apiSelector" class="api-select" onchange="toggleApiKeyInput()">
                    <option value="vision">Google Vision (Padrão)</option>
                    <option value="freeocr">Free OCR (Grátis)</option>
                </select>
            </div>

            <div id="visionKeyContainer" class="flex gap-2">
                <input type="password" id="apiKey" class="bg-gray-800 border border-gray-700 text-white text-xs p-1.5 rounded w-32" placeholder="API Key Vision...">
                <button onclick="saveKey()" class="bg-violet-600 hover:bg-violet-500 text-white text-xs font-bold px-3 py-1.5 rounded">SALVAR</button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[35%] bg-white border-r border-slate-200 flex flex-col p-4 gap-4 shadow-xl z-10">
            <div class="flex-1 flex flex-col">
                <label class="text-xs font-bold text-slate-500 mb-1 flex justify-between">
                    1. GABARITO (LISTA)
                    <span class="text-violet-600 cursor-pointer hover:underline" onclick="document.getElementById('listInput').value = ''">Limpar Texto</span>
                </label>
                <textarea id="listInput" class="flex-1 border rounded-lg p-3 text-xs font-mono bg-slate-50 focus:ring-2 focus:ring-violet-500 outline-none resize-none" placeholder="Cole a lista aqui..."></textarea>
            </div>
            
            <div class="h-32">
                <div id="dropZone" class="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                    <div class="text-xs font-bold text-slate-600">2. ARRASTE IMAGENS</div>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="runAudit()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg font-bold shadow transition text-sm flex justify-center items-center gap-2">
                    <i class="fa-solid fa-play"></i> AUDITAR
                </button>
                <button onclick="clearImages()" class="w-16 bg-red-600 hover:bg-red-500 text-white py-3 rounded-lg font-bold shadow transition text-sm flex justify-center items-center" title="Limpar">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>

        <div class="w-[65%] bg-slate-50 relative flex flex-col">
            <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                <div class="w-10 h-10 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin mb-3"></div>
                <div id="loadingText" class="text-sm font-bold text-violet-900 animate-pulse">Iniciando motor...</div>
            </div>

            <div id="resultsArea" class="flex-1 overflow-y-auto p-6">
                <div class="text-center mt-20 text-slate-400 text-sm italic">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Cole a lista e arraste as imagens.
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKey');
        const apiSelector = document.getElementById('apiSelector');
        const visionContainer = document.getElementById('visionKeyContainer');

        if(localStorage.getItem('vision_key')) apiKeyInput.value = localStorage.getItem('vision_key');
        
        function saveKey() { 
            localStorage.setItem('vision_key', apiKeyInput.value.trim()); 
            alert("Chave Vision Salva!"); 
        }

        function toggleApiKeyInput() {
            if (apiSelector.value === 'vision') {
                visionContainer.style.display = 'flex';
            } else {
                visionContainer.style.display = 'none';
            }
        }
        toggleApiKeyInput();

        const FREE_OCR_KEY = 'K87864832788957';

        let files = [];
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => { files = Array.from(e.target.files); dropZone.innerHTML = `<div class="text-violet-600 font-bold">${files.length} Arquivos</div>`; };
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#7c3aed'; };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#9ca3af'; files = Array.from(e.dataTransfer.files); dropZone.innerHTML = `<div class="text-violet-600 font-bold">${files.length} Arquivos</div>`; };

        function clearImages() {
            files = []; fileInput.value = '';
            dropZone.innerHTML = `<i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i><div class="text-xs font-bold text-slate-600">2. ARRASTE IMAGENS</div><input type="file" id="fileInput" multiple accept="image/*" class="hidden">`;
            document.getElementById('resultsArea').innerHTML = `<div class="text-center mt-20 text-slate-400 text-sm italic"><i class="fa-solid fa-check mr-2 text-green-500"></i> Pronto.</div>`;
        }

        async function runAudit() {
            const listTxt = document.getElementById('listInput').value;
            const mode = apiSelector.value;

            if(!listTxt.trim() || files.length === 0) return alert("Faltam dados!");
            if(mode === 'vision' && !apiKeyInput.value.trim()) return alert("Salve a API Key do Vision!");

            const listData = parseListV76(listTxt);
            if(Object.keys(listData).length === 0) return alert("Lista inválida.");

            document.getElementById('loading').classList.remove('hidden');
            const loadingText = document.getElementById('loadingText');
            loadingText.innerText = mode === 'vision' ? "Google Vision Processando..." : "Free OCR (Engine 2) Processando...";

            const container = document.getElementById('resultsArea');
            container.innerHTML = '';

            for(const file of files) {
                const idMatch = file.name.match(/[Pp]0*(\d+)/);
                if(!idMatch) { renderError(container, file.name, "Sem ID no arquivo"); continue; }
                const id = idMatch[1];
                const gabarito = listData[id];
                if(!gabarito) { renderError(container, file.name, `ID ${id} não está na lista.`); continue; }

                try {
                    let imgData;
                    if (mode === 'vision') {
                        imgData = await processImageVision(file, apiKeyInput.value.trim());
                    } else {
                        imgData = await processImageFreeOCR(file);
                    }
                    
                    compareAndRenderV76(container, id, gabarito, imgData, mode);
                } catch(e) { 
                    renderError(container, file.name, e.message); 
                }
            }
            document.getElementById('loading').classList.add('hidden');
        }

        // --- VISION ---
        async function processImageVision(file, key) {
            const base64 = await toBase64(file);
            const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                method: 'POST', body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] })
            });
            const json = await res.json();
            const text = json.responses[0]?.fullTextAnnotation?.text || "";
            // Vision tem boa estrutura, contexto menor ok
            return extractPricesFromText(text, 80);
        }

        // --- FREE OCR TURBO (ENGINE 2 + SCALE) ---
        async function processImageFreeOCR(file) {
            let base64 = await toBase64(file);
            // Comprime se for > 900KB
            if (file.size > 900 * 1024) { base64 = await compressImage(base64); }

            const formData = new FormData();
            formData.append("base64Image", "data:image/jpeg;base64," + base64);
            formData.append("language", "por");
            formData.append("isOverlayRequired", "false");
            formData.append("apikey", FREE_OCR_KEY);
            
            // *** MELHORIAS DA V78 ***
            formData.append("OCREngine", "2"); // Engine 2 é melhor pra numeros
            formData.append("scale", "true");  // Ajuda em texto pequeno
            formData.append("detectOrientation", "true");

            const res = await fetch("https://api.ocr.space/parse/image", {
                method: 'POST', body: formData
            });
            
            const json = await res.json();
            if (json.IsErroredOnProcessing) throw new Error("Free OCR Error: " + json.ErrorMessage);
            
            const text = json.ParsedResults && json.ParsedResults[0] ? json.ParsedResults[0].ParsedText : "";
            
            // Free OCR Engine 2 as vezes retorna quebras de linha estranhas
            // Aumentamos o contexto de busca para 150 chars
            return extractPricesFromText(text, 150);
        }

        // --- LÓGICA DE EXTRAÇÃO COMUM ---
        function extractPricesFromText(rawText, lookBackChars) {
            let clean = rawText.replace(/\r/g, '').replace(/([0-9SBOlIZ]{1,3})[,.]([0-9SBOlIZ]{2})\b/g, (match) => {
                return match.replace(/S/g, '5').replace(/[O]/g, '0').replace(/B/g, '8').replace(/[lI]/g, '1').replace(/Z/g, '2');
            });

            const pricesFound = [];
            const pRegex = /(\d{1,3}(?:\.\d{3})*)[,.](\d{2})\b/g;
            let m;
            while ((m = pRegex.exec(clean)) !== null) {
                const val = parseFloat(m[0].replace('.','').replace(',','.'));
                if(!(val >= 2020 && val <= 2030 && Number.isInteger(val))) {
                     pricesFound.push({ val, index: m.index });
                }
            }

            const rawNumbers = [...pricesFound]; 
            let basePrice = null;
            const offers = [];
            const buyIdx = clean.toUpperCase().indexOf("COMPRAR");
            let baseFound = false;

            if(buyIdx !== -1) {
                const candidates = pricesFound.filter(p => p.index < buyIdx);
                if(candidates.length) {
                    const p = candidates[candidates.length - 1];
                    basePrice = p.val;
                    baseFound = true;
                    pricesFound.splice(pricesFound.indexOf(p), 1);
                }
            }

            const iTriggers = [
                { k: "SAVE", t: "SAVE GANHE" }, { k: "CARTÃO", t: "NOSSO CARTÃO" },
                { k: "EMBALAGEM", t: "EMBALAGEM" }, { k: "LEVANDO", t: "EMBALAGEM" }, { k: "A PARTIR", t: "EMBALAGEM" }, { k: "UNIDADE", t: "EMBALAGEM" }
            ];

            pricesFound.forEach(p => {
                // Olha para trás com o tamanho definido (Vision=80, Free=150)
                const ctx = clean.substring(Math.max(0, p.index - lookBackChars), p.index).toUpperCase().replace(/\n/g,' ');
                
                let bestT = null, minD = 9999;
                
                for(const t of iTriggers) { 
                    const idx = ctx.lastIndexOf(t.k);
                    if(idx !== -1) {
                        const dist = ctx.length - idx; // Distancia do fim do trigger até o preço
                        if (dist < minD) { minD = dist; bestT = t.t; }
                    }
                }
                
                // Se achou trigger perto (até 100 chars pra Free OCR), vincula
                if(bestT && minD < 100) { 
                    offers.push({ type: bestT, val: p.val }); 
                }
                else if(!baseFound) { 
                    basePrice = p.val; baseFound = true; 
                }
            });

            return { basePrice, offers, rawText: clean, rawNumbers };
        }

        // --- AUXILIARES ---
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function compressImage(base64) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = "data:image/jpeg;base64," + base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1000;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]); 
                };
            });
        }

        // --- LIST PARSER (Mantido) ---
        function parseListV76(txt) {
            const map = {};
            const lines = txt.split('\n');
            let currentItem = null;
            lines.forEach(line => {
                line = line.trim(); if(!line) return;
                const idMatch = line.match(/^(\d+)\s*-\s*(.+)/);
                if (idMatch) {
                    if (currentItem) processListBlock(map, currentItem);
                    currentItem = { id: idMatch[1], text: line };
                } else if (currentItem) currentItem.text += " " + line;
            });
            if (currentItem) processListBlock(map, currentItem);
            return map;
        }

        function processListBlock(map, item) {
            const text = item.text.replace(/\s+/g, ' ').trim();
            let title = text.match(/^(.*?)(?=\s\(red|–\s*R\$|R\$)/i)?.[1]?.replace(/^\d+\s*-\s*/, '').trim() || text;
            let basePrice = null;
            const offers = [];
            const pricesFound = [];
            const priceRegex = /R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})/gi;
            let match;
            while ((match = priceRegex.exec(text)) !== null) {
                pricesFound.push({ val: parseFloat(match[1].replace('.','').replace(',','.')), index: match.index, assigned: false });
            }

            const redMatch = text.match(/R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})\s*\(red/i);
            if (redMatch) {
                const val = parseFloat(redMatch[1].replace('.','').replace(',','.'));
                const p = pricesFound.find(p => Math.abs(p.val - val) < 0.001);
                if(p) { basePrice = p.val; p.assigned = true; }
            } else {
                const dashMatch = text.match(/–\s*R\$\s*(\d{1,3}(?:\.\d{3})*,\d{2})/);
                if (dashMatch) {
                    const val = parseFloat(dashMatch[1].replace('.','').replace(',','.'));
                    const p = pricesFound.find(p => Math.abs(p.val - val) < 0.001);
                    if(p) { basePrice = p.val; p.assigned = true; }
                }
            }

            const triggers = [
                { k: "CARTÃO", t: "NOSSO CARTÃO" }, { k: "SAVE", t: "SAVE GANHE" },
                { k: "EMBALAGEM", t: "EMBALAGEM" }, { k: "SAI POR", t: "EMBALAGEM" },
                { k: "UNIDADE", t: "EMBALAGEM" }, { k: "LEVANDO", t: "EMBALAGEM" }
            ];

            pricesFound.forEach(p => {
                if(p.assigned) return;
                const ctx = text.substring(Math.max(0, p.index - 80), p.index).toUpperCase();
                let bestT = null, minD = 9999;
                triggers.forEach(t => {
                    const idx = ctx.lastIndexOf(t.k);
                    if(idx !== -1 && (ctx.length - idx) < minD) { minD = ctx.length - idx; bestT = t; }
                });
                if(bestT && minD < 60) { offers.push({ type: bestT.t, val: p.val }); p.assigned = true; }
            });

            if(!basePrice) { const l = pricesFound.find(p => !p.assigned); if(l) basePrice = l.val; }
            map[item.id] = { title, basePrice, offers };
        }

        // --- RENDER (Mantido) ---
        function compareAndRenderV76(container, id, gabarito, imagem, mode) {
            const rows = [];
            let errorCount = 0;

            if (gabarito.basePrice) {
                if (imagem.basePrice) {
                    if (Math.abs(gabarito.basePrice - imagem.basePrice) < 0.05) {
                        rows.push(rowHtml("BASE", gabarito.basePrice, imagem.basePrice, "OK"));
                    } else {
                        rows.push(rowHtml("BASE", gabarito.basePrice, imagem.basePrice, "DIVERGENTE"));
                        errorCount++;
                    }
                } else {
                    rows.push(rowHtml("BASE", gabarito.basePrice, null, "SUMIU"));
                    errorCount++;
                }
            }

            gabarito.offers.forEach(req => {
                const matchType = imagem.offers.find(o => o.type === req.type);
                if (matchType) {
                    if (Math.abs(matchType.val - req.val) < 0.05) {
                        rows.push(rowHtml(req.type, req.val, matchType.val, "OK"));
                    } else {
                        rows.push(rowHtml(req.type, req.val, matchType.val, "DIVERGENTE"));
                        errorCount++;
                    }
                } else {
                    const matchVal = imagem.offers.find(o => Math.abs(o.val - req.val) < 0.05);
                    if(matchVal) {
                        rows.push(rowHtml(req.type, req.val, matchVal.val, "WARN", `Achado como ${matchVal.type}`));
                        errorCount++;
                    } else {
                        rows.push(rowHtml(req.type, req.val, null, "SUMIU"));
                        errorCount++;
                    }
                }
            });

            const status = errorCount === 0 ? "APROVADO" : "REPROVADO";
            const badgeClass = errorCount === 0 ? "badge-pass" : "badge-fail";
            const div = document.createElement('div');
            div.className = "result-card animate-fade-in";
            const debugId = `debug-${id}`;
            const engineLabel = mode === 'vision' ? 'Google Vision' : 'Free OCR';
            
            div.innerHTML = `
                <div class="card-header">
                    <div>
                        <span class="font-bold text-sm text-slate-700">${gabarito.title} (ID ${id})</span>
                        <span class="text-[9px] text-gray-400 ml-1">via ${engineLabel}</span>
                    </div>
                    <span class="badge ${badgeClass}">${status}</span>
                </div>
                <table class="comp-table">
                    <thead><tr><th>Item</th><th>Esperado</th><th>Encontrado</th><th>Status</th></tr></thead>
                    <tbody>${rows.join('')}</tbody>
                </table>
                <div class="text-center p-2 border-t border-slate-100">
                    <button onclick="document.getElementById('${debugId}').style.display = 'block'" class="text-[10px] text-violet-500 hover:underline">
                        <i class="fa-solid fa-microscope"></i> Ver Detalhes
                    </button>
                </div>
                <div id="${debugId}" class="debug-panel">
                    <strong>Números:</strong> ${imagem.rawNumbers.map(n=>n.val).join(', ')}<br>
                    <strong>Texto Lido:</strong><br>${imagem.rawText.substring(0, 200)}...
                </div>
            `;
            container.prepend(div);
        }

        function rowHtml(label, exp, found, status, obs="") {
            let icon, stClass, valHtml;
            const expFmt = fmt(exp);
            if (status === "OK") { icon = '✔'; stClass = 'status-ok'; valHtml = `<span class="price-tag bg-ok">R$ ${fmt(found)}</span>`; }
            else if (status === "DIVERGENTE") { icon = '✖'; stClass = 'status-err'; valHtml = `<span class="price-tag bg-err">R$ ${fmt(found)}</span>`; }
            else if (status === "WARN") { icon = '⚠'; stClass = 'status-warn'; valHtml = `<span class="price-tag bg-ref">R$ ${fmt(found)}</span> <span class="text-[9px]">${obs}</span>`; }
            else { icon = '✖'; stClass = 'status-err'; valHtml = `<span class="price-tag bg-miss">---</span>`; }
            return `<tr><td class="font-bold text-slate-600">${label}</td><td><span class="font-mono font-bold text-violet-800">R$ ${expFmt}</span></td><td>${valHtml}</td><td class="${stClass}">${icon} ${status}</td></tr>`;
        }

        function renderError(c, t, m) { c.innerHTML += `<div class="p-3 bg-red-100 text-red-800 text-xs rounded mb-2"><strong>${t}:</strong> ${m}</div>`; }
        const fmt = n => n.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    </script>
</body>
</html>
