<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor V46 - Tolerância Zero</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        .header { background: #1e293b; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 20; }
        
        .drop-zone { border: 2px dashed #94a3b8; border-radius: 8px; background: #f8fafc; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .drop-zone:hover { border-color: #ef4444; background: #fef2f2; }

        /* Cards */
        .result-card { background: white; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { padding: 10px 15px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 0; } /* Padding removido para tabela full width */

        /* Tabelas */
        .audit-table { width: 100%; text-align: left; font-size: 13px; border-collapse: collapse; }
        .audit-table th { background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 2px solid #e2e8f0; padding: 10px 15px; text-transform: uppercase; font-size: 11px; }
        .audit-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .audit-table tr:last-child td { border-bottom: none; }

        /* Estilos de Preço */
        .price-expected { font-family: monospace; font-weight: bold; font-size: 14px; color: #334155; }
        
        .status-ok { color: #16a34a; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .status-err { color: #dc2626; font-weight: bold; display: flex; align-items: center; gap: 6px; }

        .divergence-box { background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; padding: 6px; margin-top: 6px; }
        .divergence-label { font-size: 10px; color: #991b1b; font-weight: bold; text-transform: uppercase; }
        .divergence-val { font-family: monospace; font-weight: bold; color: #b91c1c; font-size: 13px; }

        /* Badges Gerais */
        .badge { font-size: 11px; font-weight: bold; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; }
        .bg-ok { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .bg-err { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .bg-warn { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
    </style>
</head>
<body class="text-slate-800">

    <header class="header">
        <div class="flex items-center gap-3">
            <div class="bg-red-600 p-1.5 rounded text-white"><i class="fa-solid fa-gavel"></i></div>
            <div>
                <h1 class="font-bold text-lg leading-none">Auditor V46</h1>
                <p class="text-[10px] text-slate-400">Auditoria Rigorosa (Vision)</p>
            </div>
        </div>
        <div class="flex gap-2">
            <input type="password" id="apiKey" class="bg-slate-800 border border-slate-700 text-white text-xs p-1.5 rounded w-32" placeholder="API Key Vision...">
            <button onclick="saveKey()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded">SALVAR</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-[35%] bg-white border-r border-slate-200 flex flex-col p-4 gap-4 shadow-xl z-10">
            <div class="flex-1 flex flex-col">
                <label class="text-xs font-bold text-slate-500 mb-1 flex justify-between">
                    1. LISTA GABARITO (A Lei)
                    <span class="text-blue-600 cursor-pointer hover:underline" onclick="document.getElementById('listInput').value = ''">Limpar</span>
                </label>
                <textarea id="listInput" class="flex-1 border rounded-lg p-3 text-xs font-mono bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="1 - Cerveja Skol&#10;R$ 4,99&#10;&#10;5 - Feijão..."></textarea>
                <p class="text-[10px] text-slate-400 mt-1">* Se o preço não estiver EXATAMENTE igual na imagem, será marcado como erro.</p>
            </div>
            
            <div class="h-32">
                <div id="dropZone" class="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 mb-2"></i>
                    <div class="text-xs font-bold text-slate-500">ARRASTE OS ENCARTES</div>
                    <div class="text-[10px] text-slate-400">Nome: P1.jpg, P5.png...</div>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                </div>
            </div>

            <button onclick="processQueue()" class="bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg font-bold shadow transition text-sm flex justify-center items-center gap-2">
                <i class="fa-solid fa-check-double"></i> CONFERIR DIVERGÊNCIAS
            </button>
        </div>

        <div class="w-[65%] bg-slate-50 relative flex flex-col">
            <div id="loading" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                <div class="w-10 h-10 border-4 border-red-200 border-t-red-600 rounded-full animate-spin mb-3"></div>
                <div class="text-sm font-bold text-red-900 animate-pulse">Auditando preços...</div>
            </div>

            <div class="p-3 border-b border-slate-200 bg-white font-bold text-xs text-slate-600 shadow-sm flex justify-between">
                <span>RELATÓRIO DE DIVERGÊNCIAS</span>
                <span class="text-[10px] bg-slate-100 px-2 rounded">API Google Vision</span>
            </div>

            <div id="resultsArea" class="flex-1 overflow-y-auto p-6">
                <div class="text-center mt-20 text-slate-400 text-sm italic">
                    <i class="fa-solid fa-clipboard-list mr-2"></i> Cole a lista e arraste as imagens.
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const apiKeyInput = document.getElementById('apiKey');
        if(localStorage.getItem('vision_key')) apiKeyInput.value = localStorage.getItem('vision_key');
        
        function saveKey() {
            localStorage.setItem('vision_key', apiKeyInput.value.trim());
            alert("Chave salva!");
        }

        // DRAG & DROP
        let files = [];
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFiles(Array.from(e.target.files));
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#3b82f6'; };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#94a3b8'; handleFiles(Array.from(e.dataTransfer.files)); };

        function handleFiles(newFiles) {
            files = newFiles;
            dropZone.innerHTML = `<div class="text-blue-600 font-bold text-sm"><i class="fa-solid fa-images"></i> ${files.length} Arquivos</div>`;
        }

        // PROCESSAMENTO
        async function processQueue() {
            const key = apiKeyInput.value.trim();
            const listTxt = document.getElementById('listInput').value;
            
            if(!key) return alert("Falta a API Key!");
            if(!listTxt) return alert("Falta a Lista!");
            if(files.length === 0) return alert("Faltam Imagens!");

            const listMap = parseList(listTxt);
            if(Object.keys(listMap).length === 0) return alert("Lista inválida. Use o formato: '1 - Produto'.");

            document.getElementById('loading').classList.remove('hidden');
            const container = document.getElementById('resultsArea');
            container.innerHTML = '';

            for (const file of files) {
                try {
                    await auditFile(file, key, listMap, container);
                } catch (err) {
                    container.innerHTML += `<div class="p-4 bg-red-100 text-red-800 rounded mb-2 border border-red-200 text-xs">Erro em ${file.name}: ${err.message}</div>`;
                }
            }
            document.getElementById('loading').classList.add('hidden');
            files = [];
            dropZone.innerHTML = `<i class="fa-solid fa-check text-green-500 text-2xl"></i>`;
        }

        async function auditFile(file, key, listMap, container) {
            // 1. Acha ID (P1, P05...)
            const idMatch = file.name.match(/[Pp]0*(\d+)/);
            if(!idMatch) {
                renderIgnored(container, file.name, "Nome do arquivo sem ID (P + Número)");
                return;
            }
            const id = idMatch[1];
            const target = listMap[id];

            if(!target) {
                renderIgnored(container, file.name, `ID ${id} não está na lista gabarito.`);
                return;
            }

            // 2. Extrai Texto (Vision)
            const base64 = await toBase64(file);
            const apiRes = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                method: 'POST',
                body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: "TEXT_DETECTION" }] }] })
            });
            const data = await apiRes.json();
            if(data.error) throw new Error(data.error.message);
            
            const rawText = data.responses[0]?.fullTextAnnotation?.text || "";

            // 3. Extrai TODOS os preços da imagem
            const imgPrices = [];
            const matches = rawText.matchAll(/(\d{1,3}(?:\.\d{3})*)[,.](\d{2})\b/g);
            for (const m of matches) {
                const val = parseFloat(m[0].replace('.','').replace(',','.'));
                // Ignora anos se não tiver R$
                if(val >= 2020 && val <= 2030 && !rawText.includes('$' + m[0])) continue;
                imgPrices.push(val);
            }

            // 4. AUDITORIA RIGOROSA (Lista vs Imagem)
            let rowsHtml = "";
            let errorsCount = 0;

            target.prices.forEach(req => {
                // Procura EXATAMENTE o preço da lista na imagem (margem mínima de 0.05)
                const found = imgPrices.find(p => Math.abs(p - req.val) < 0.05);

                if (found !== undefined) {
                    // SUCESSO
                    rowsHtml += `
                        <tr>
                            <td>
                                <div class="font-bold text-slate-700">${req.context}</div>
                                <div class="text-[10px] text-slate-400">Preço correto</div>
                            </td>
                            <td><span class="price-expected">R$ ${fmt(req.val)}</span></td>
                            <td><div class="status-ok"><i class="fa-solid fa-circle-check"></i> OK</div></td>
                        </tr>`;
                } else {
                    // ERRO - DIVERGÊNCIA
                    errorsCount++;
                    
                    // Tenta adivinhar qual preço ERRADO está na imagem
                    // Pega o preço mais próximo matematicamente
                    let divergentPrice = null;
                    let minDiff = 999999;
                    
                    imgPrices.forEach(p => {
                        const diff = Math.abs(p - req.val);
                        if(diff < minDiff) { minDiff = diff; divergentPrice = p; }
                    });

                    // Se a diferença for muito grande (> R$100), talvez nem seja o preço certo,
                    // mas vamos mostrar mesmo assim pra ajudar
                    let divergenceHtml = "";
                    if (divergentPrice !== null) {
                        divergenceHtml = `
                            <div class="divergence-box">
                                <div class="divergence-label">Na Imagem consta:</div>
                                <div class="divergence-val">R$ ${fmt(divergentPrice)}</div>
                            </div>`;
                    } else {
                        divergenceHtml = `<div class="text-[10px] text-red-400 mt-1">Nenhum preço similar encontrado.</div>`;
                    }

                    rowsHtml += `
                        <tr class="bg-red-50/50">
                            <td>
                                <div class="font-bold text-slate-800">${req.context}</div>
                                <div class="text-[10px] text-red-600 font-bold uppercase">Preço Divergente</div>
                            </td>
                            <td><span class="price-expected text-red-800">R$ ${fmt(req.val)}</span></td>
                            <td>
                                <div class="status-err"><i class="fa-solid fa-circle-xmark"></i> ERRO</div>
                                ${divergenceHtml}
                            </td>
                        </tr>`;
                }
            });

            // Renderiza Card Final
            const badge = errorsCount === 0 
                ? `<span class="badge bg-ok">APROVADO</span>` 
                : `<span class="badge bg-err">${errorsCount} DIVERGÊNCIA(S)</span>`;
            
            const borderClass = errorsCount === 0 ? "border-green-200" : "border-red-300";

            const div = document.createElement('div');
            div.className = `result-card animate-fade-in ${borderClass}`;
            div.innerHTML = `
                <div class="card-header">
                    <span class="font-bold text-sm text-slate-700">
                        <span class="bg-slate-800 text-white px-1.5 rounded text-xs mr-2">ID ${id}</span> ${target.name}
                    </span>
                    ${badge}
                </div>
                <div class="card-body">
                    <table class="audit-table">
                        <thead><tr><th width="40%">Descrição</th><th width="30%">Esperado (Lista)</th><th width="30%">Status</th></tr></thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                    <div class="px-4 py-2 bg-slate-50 border-t border-slate-100 text-[10px] text-slate-400 font-mono">
                        Arquivo: ${file.name} | Leitura Bruta: ${imgPrices.join(' | ')}
                    </div>
                </div>
            `;
            container.prepend(div);
        }

        // --- UTILS ---
        function renderIgnored(container, title, reason) {
            const div = document.createElement('div');
            div.className = "result-card border-slate-200 opacity-70";
            div.innerHTML = `
                <div class="card-header bg-slate-50">
                    <span class="font-bold text-xs text-slate-500">${title}</span>
                    <span class="badge bg-warn">IGNORADO</span>
                </div>
                <div class="p-3 text-xs text-slate-500">${reason}</div>
            `;
            container.append(div);
        }

        function parseList(txt) {
            const map = {};
            let currentId = null;
            let currentName = "";

            txt.split('\n').forEach(line => {
                line = line.trim();
                if(!line) return;

                // Captura ID: "1 - Produto"
                const idMatch = line.match(/^(\d+)\s*-\s*(.+)/);
                if(idMatch) {
                    currentId = idMatch[1];
                    currentName = idMatch[2];
                    map[currentId] = { name: currentName, prices: [] };
                    return;
                }

                if(currentId) {
                    // Captura preços (R$ XX,XX ou XX,XX)
                    const prices = line.match(/(?:R\$\s*)?(\d{1,3}(?:\.\d{3})*,\d{2})/g);
                    if(prices) {
                        prices.forEach(pStr => {
                            const val = parseFloat(pStr.replace(/[R$\s]/g,'').replace('.','').replace(',','.'));
                            // Descrição: usa o resto da linha (ex: "Nesta embalagem")
                            let desc = line.replace(pStr, '').replace('R$', '').trim();
                            if(desc.length < 2) desc = "Preço Base"; 
                            
                            map[currentId].prices.push({ val, context: desc });
                        });
                    }
                }
            });
            return map;
        }

        function toBase64(file) {
            return new Promise((r, j) => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.onerror = j;
                reader.readAsDataURL(file);
            });
        }
        
        const fmt = n => n.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    </script>
</body>
</html>
